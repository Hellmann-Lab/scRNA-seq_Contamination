---
title: "Benchmark of background RNA correction methods"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/data/share/htp/CZI_kidney/mouse_experiments/backgroundRNA")

library(tidyverse)
library(cowplot)
library(SingleR)

method_colors = setNames(c("#FF6F59", "#254441", "#43AA8B", "lightgrey", "lightgrey", "lightgrey"),
                         c("CellBender", "SoupX", "DecontX", "Genotype estimate", "raw", "uncorrected"))

method_colors2 = setNames(c("lightgrey", "lightgrey","#FF6F59", "#254441", "#43AA8B", "#9EEED2"),
                         c("Genotype estimate", "raw", "CellBender", "SoupX", "DecontX_default", "DecontX_background"))

replicate_colors <- setNames(c("#F6D6B0","#917AA6","#D4E7A5", "lightgrey"), 
                             c("rep1", "rep2", "rep3", "nuc2")) 
```

## COLLECT EVALUATION METRICS

### Estimation accuracy

Within the Snakemake workflow the output of each method and parameter setting was compared to the genotype estimates for CAST cells of that replicate to calculate Kendall's tau and RMSLE values.

```{r estimation_accuracy}
l_est <- list()
for(method in c("CellBender", "DecontX", "SoupX")){
  for(rep in c("rep1","rep2","rep3", "nuc2", "nuc3")){ 
    estimation_accuracy <- readRDS(paste0("Snakemake_backup/benchmark/evaluation/",method,"/",rep,"/estimation_accuracy.RDS"))
    l_est[[method]][[rep]]<- estimation_accuracy %>% pivot_longer(cols = c("tau","rmsle"), names_to = "metric")
  }
  l_est[[method]] <- bind_rows(l_est[[method]], .id = "replicate")
} 

df_est <-  bind_rows(l_est, .id = "method") %>% mutate(evaluation_category = "estimation_accuracy")
```

### Cell type identification

#### Clustering evaluation

In the Snakemake workflow multiple external and internal cluster evaluation metrics were calculated using the cell type labels obtained by classifying the uncorrected data as reference labels.  
External cluster evaluation metrics: Clustering of corrected data --> compare cluster labels to cell type labels
Internal (silhouette scores): Calculated on the corrected data with cell type labels --> per cell silhouette scores were summarized per celltype (silhouette_[celltype]) and averaged across cell types to obtain a global "avg_silhouette".

```{r cluster_evaluation}
l_cluster <- list()
for(method in c("CellBender", "DecontX", "SoupX","raw")){
  for(rep in c("rep1","rep2","rep3","nuc2")){ 
    cluster_evaluation_internal <- readRDS(paste0("Snakemake_backup/benchmark/evaluation/",method,"/",rep,"/cluster_evaluation_internal_cor.RDS"))
    cluster_evaluation_external <- readRDS(paste0("Snakemake_backup/benchmark/evaluation/",method,"/",rep,"/cluster_evaluation_external_cor.RDS"))
    l_cluster[[method]][[rep]] <- rbind(cluster_evaluation_external, cluster_evaluation_internal)
  }
  l_cluster[[method]] <- bind_rows(l_cluster[[method]], .id = "replicate")
} 

df_cluster <-  bind_rows(l_cluster, .id = "method") %>% mutate(evaluation_category = "cluster_evaluation")

# Calculate average silhouette score per cell type cluster
df_silhouette_ct <- df_cluster %>% 
  filter(grepl("silhouette_", metric)) %>% 
  group_by(method, replicate, param) %>% 
  dplyr::summarize(metric = "avg_silhouette",
            value = mean(value),
            evaluation_category = "cluster_evaluation")

df_cluster <- rbind(df_cluster, df_silhouette_ct)

saveRDS(df_cluster, "Extra_analyses/benchmark_metrics_cluster.RDS")
```

!Silhouette scores were also obtained per cell, this could still be included in the comparison!

#### Classification evaluation

Each corrected dataset was reclassified with SingleR using the Denisenko et al. data as reference. SingleR provides "delta" values as a measure for classification confidence, which depicts the difference of the assignment score for the assigned label and teh median score across all labels.  
Results are evaluated with respect towards overlap of the newly assigned labels to the labels obtained for the uncorrected data and for the change of "delta" values, called "prediction_score" here. 

```{r classification_evaluation}
l_classification <- list()
for(method in c("CellBender", "DecontX", "SoupX","raw")){
  for(rep in c("rep1","rep2","rep3", "nuc2")){ 
    classification <- readRDS(paste0("Snakemake_backup/benchmark/evaluation/",method,"/",rep,"/classification_evaluation.RDS"))
    l_classification[[method]][[rep]]<-  lapply(classification, function(x){
      deltas <- lapply(x$prediction_result@listData$orig.results, 
                       getDeltaFromMedian)
      res <- data.frame(cell = rownames(x$prediction_result),
                        label = x$prediction_result@listData$pruned.labels,
                        reference = x$prediction_result@listData$reference) %>% 
        mutate(index = row_number(),
               prediction_score = map2_dbl(reference,index, function(ref,i)deltas[[ref]][i]))
      return(res)
    }) %>% bind_rows(.id = "param")
  }
  l_classification[[method]] <- bind_rows(l_classification[[method]], .id = "replicate")
} 

df_classification <-  bind_rows(l_classification, .id = "method") %>% mutate(evaluation_category = "classification_evaluation")

# Merge some labels into a broader category
df_classification <- df_classification %>% 
  mutate(celltype = case_when(label %in% c("CD_IC","CD_IC_A","CD_IC_B") ~ "CD_IC",
                              #celltype %in% c("aLOH","dLOH") ~ "LOH",
                              label %in% c("T","NK","B","MPH") ~ "Immune",
                              T ~ label))

```


Identify overlapping labels between uncorrected and reclassified corrected data and calculate the difference in prediction_scores for those. 
This results in two tables: df_classification_summary (summarizing prediction scores) and df_classification_overlap (summarizing overlap of labels).  

```{r classification_eval_summary}
# compare raw and corrected assignments
class_overlap_df <- df_classification %>% 
  filter(method == "raw") %>% 
  mutate(celltype_uncorrected = celltype, 
         prediction_score_uncorrected = prediction_score,
         label_uncorrected = label) %>% 
  dplyr::select(replicate,cell, celltype_uncorrected, prediction_score_uncorrected, label_uncorrected) %>% 
  right_join(df_classification)

# calculate difference to uncorrected values for cells that were classified the same:
df_classification_summary <- class_overlap_df %>% 
  ungroup() %>% 
  group_by(replicate) %>% 
  mutate(difference = prediction_score - prediction_score_uncorrected) %>%
  filter(!is.na(celltype), #method != "raw"
         celltype == celltype_uncorrected                          # only consider overlapping labels, so that prediction scores are not compared across cell types
  ) %>%  
  group_by(method, replicate, param, celltype) %>% 
  summarize(perCT_difference = mean(difference),
            perCT_prediction_score = mean(prediction_score),
            perCT_uncorrected = mean(prediction_score_uncorrected)) %>% 
  group_by(method, replicate, param) %>% 
  summarize(metric = "prediction_score",
            value = mean(perCT_prediction_score),
            evaluation_category = "cluster_evaluation",
            delta = mean(perCT_difference),
            rel_change = delta / mean(perCT_uncorrected))

df_classifcation_overlap <- class_overlap_df %>% 
  filter(!is.na(celltype) & !is.na(celltype_uncorrected) & method != "raw") %>% 
  group_by(method, replicate, param) %>% 
  summarize(metric = "classification_overlap",
            value = sum(celltype == celltype_uncorrected) / length(celltype),
            evaluation_category = "classification",
            delta = NA, rel_change = NA)
```

### kNN overlap

```{r kNN_overlap_results}
l_kNN <- list()
for(method in c("CellBender", "DecontX", "SoupX","raw")){
  for(rep in c("rep1","rep2","rep3", "nuc2")){ 
    l_kNN[[method]][[rep]]<- readRDS(paste0("Snakemake_backup/benchmark/evaluation/",method,"/",rep,"/kNN_overlap.RDS")) 
    } #%>% bind_rows(.id = "param")
  l_kNN[[method]] <- bind_rows(l_kNN[[method]], .id = "replicate") %>% 
    pivot_longer(-replicate, names_to = "param", values_to = "value")
}

df_kNN <-  bind_rows(l_kNN, .id = "method") %>% mutate(metric = "kNN_overlap", evaluation_category = "cluster_evaluation")

```

```{r kNN_overlap}
kNN_list <- readRDS("Extra_analyses/kNN_list_param.RDS")

calculate_kNN_overlap <- function(ref_kNN, test_kNN){
  mean(sapply(seq_len(nrow(test_kNN)), function(cell_idx){
    length(intersect(ref_kNN[cell_idx,], test_kNN[cell_idx,]))}))
}

df_kNN_param <- lapply(kNN_list, function(x){
  lapply(setNames(c("raw","CellBender","DecontX","SoupX"), c("raw","CellBender","DecontX","SoupX")), function(method){
    calculate_kNN_overlap(x$ref, x[[method]])
  }) %>% bind_rows(.id = "method")
}) %>% bind_rows(.id = "name")

df_kNN_k50_dim30 <- df_kNN_param %>% 
  pivot_longer(cols = -name, values_to = "value", names_to = "method") %>% 
  filter(grepl("_50_30",name)) %>% 
  mutate(metric = "kNN_overlap",
         evaluation_category = "cluster_evaluation",
         param = case_when(method == "raw" ~ "raw",
                           method == "CellBender" ~ "fpr0.01_total25000",
                           method == "DecontX" ~ "resDefault_emptyFalse",
                           method == "SoupX" ~ "res1_contAuto"),
         replicate = word(name,1,1,sep="_")) %>% 
  dplyr::select(method, replicate,param,metric,value,evaluation_category)


df_kNN_k50_dim30 %>% 
  filter(k ==50, ndim == 30,
         method != "raw") %>% 

  ggplot(aes(x = replicate, y= absolute_change, color = method))+
    geom_hline(yintercept = 0)+
      geom_jitter(size = 3, width = 0.2)+
      coord_flip()+
    scale_color_manual (values = method_colors, limits = force)+
    #facet_grid(replicate~., scales = "free")+
      theme_bw()+
    theme(axis.title.y = element_blank())+
    labs(y = "Change in kNN overlap")

```


### Marker gene detection evaluation

A list of marker genes for Proximal Tubule cells from the panglao database was evaluated for unspecific expression in other cell types and lfc comparing PT vs all other cells using limma.  
Unspecific expression: expression_fraction  = fraction of non PT cells with expression -> averaged over all genes
                       log_ratio_expression = ratio of exression fraction in non-PT vs PT cells -> also averaged over all genes
                       
```{r marker_evaluation}
### limma: 
l_lfc_perGene <- list()
for(method in c("raw", "CellBender", "DecontX", "SoupX")){
  for(rep in  c("rep1", "rep2","rep3", "nuc2")){ 
    differential_expression <- readRDS(paste0("Snakemake_backup/benchmark/evaluation/",method,"/",rep,"/differential_expression.RDS"))
    l_lfc_perGene[[method]][[rep]] <- differential_expression %>% 
      filter(gene %in% panglao_markers)
  }
  l_lfc_perGene[[method]] <- bind_rows(l_lfc_perGene[[method]], .id = "replicate")
} 

df_lfc_perGene <- bind_rows(l_lfc_perGene, .id = "method")

# select the top PT markers
topGenes <- df_lfc_perGene %>% 
  filter(method == "raw") %>% 
  group_by(gene) %>% 
  summarize(mean_logFC = mean(logFC),
            mean_AveExpr = mean(AveExpr)) %>% 
 # arrange(desc(mean_logFC)) %>%  
  arrange(desc(mean_AveExpr)) %>%  
  pull(gene) %>% .[1:10]

saveRDS(topGenes, "Extra_analyses/top10_PT_markers.RDS")


### Seurat lfcs: 
l_lfc_perGene_seurat <- list()
for(method in c("raw", "CellBender", "DecontX", "SoupX")){
  for(rep in  c("rep1", "rep2","rep3", "nuc2")){ 
    differential_expression <- readRDS(paste0("Snakemake_backup/benchmark/evaluation/",method,"/",rep,"/differential_expression_seurat.RDS"))
    l_lfc_perGene_seurat[[method]][[rep]] <- differential_expression %>% data.frame %>% 
       rownames_to_column("gene") %>% 
       mutate(gene = gsub("\\..*", "", gene)) %>% 
       dplyr::filter(gene %in% panglao_markers)
  }
  l_lfc_perGene_seurat[[method]] <- bind_rows(l_lfc_perGene_seurat[[method]], .id = "replicate")
} 

df_lfc_perGene_seurat <- bind_rows(l_lfc_perGene_seurat, .id = "method")



#### Evaluate expression fraction ######
l_expr <- list()
for(method in c("raw", "CellBender", "DecontX", "SoupX")){
  for(rep in c("rep1","rep2","rep3","nuc2")){ 
    expression_fraction_PT_markers <- readRDS(paste0("Snakemake_backup/benchmark/evaluation/",method,"/",rep,"/expression_fraction_PT_markers.RDS"))
    l_expr[[method]][[rep]] <- expression_fraction_PT_markers %>% 
      filter(expr_within_celltype > 0,
             gene %in% topGenes) %>% 
      group_by(param) %>% 
      summarise(expression_fraction = mean(expr_within_others),
                log_ratio_expression = mean(-log((expr_within_others+1)/(expr_within_celltype + 1)))) %>% 
      pivot_longer(cols = c(expression_fraction, log_ratio_expression), names_to = "metric", values_to = "value")
  }
  l_expr[[method]] <- bind_rows(l_expr[[method]], .id = "replicate")
} 

df_expr <-  bind_rows(l_expr, .id = "method") %>% mutate(evaluation_category = "marker_evaluation")

# log fold changes:
#panglao_markers <- readRDS("/data/share/htp/CZI_kidney/mouse_experiments/backgroundRNA/files/panglao_markers_Mm.RDS")

#tmp<- lapply( c("raw", "CellBender", "DecontX", "SoupX"), function(method))




l_lfc <- list()
for(method in c("raw", "CellBender", "DecontX", "SoupX")){
  for(rep in  c("rep1", "rep2","rep3", "nuc2")){ 
    differential_expression <- readRDS(paste0("Snakemake_backup/benchmark/evaluation/",method,"/",rep,"/differential_expression_seurat.RDS"))
    l_lfc[[method]][[rep]] <- differential_expression %>% 
       data.frame %>% 
       rownames_to_column("gene") %>% 
       mutate(gene = gsub("\\..*", "", gene)) %>% 
       dplyr::filter(gene %in% topGenes) %>% 
       group_by(param) %>% 
        summarise(metric = "lfc", value = mean(avg_log2FC))
  }
  l_lfc[[method]] <- bind_rows(l_lfc[[method]], .id = "replicate")
} 

df_lfc <-  bind_rows(l_lfc, .id = "method") %>% mutate(evaluation_category = "marker_evaluation")
```

### Combine all metrics

```{r combine_metrics}
df_eval_metrics <- df_cluster %>% 
  rbind(df_expr) %>% 
  rbind(df_lfc) %>% 
  rbind(df_kNN) %>% 
  group_by(replicate, metric) %>% 
  mutate(delta = value - value[method == "raw"],
         rel_change = delta/abs(value[method == "raw"])) %>% 
  ungroup() %>% 
  rbind(mutate(df_est, delta = value, rel_change = NA)) %>% 
  rbind(df_classification_summary) %>% 
  rbind(df_classifcation_overlap) %>% 
  mutate(default = (method == "CellBender" & param == "fpr0.01_total25000" |
                    method == "DecontX" & param == "resDefault_emptyFalse" |
                    method == "DecontX" & param == "resDefault_emptyTrue" |
                    method == "SoupX" & param == "res1_contAuto" |
                    method == "raw"),
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc3", "nuc2")),
         method2 = case_when(method == "DecontX" & param == "resDefault_emptyFalse" ~ "DecontX_default",
                             method == "DecontX" & param == "resDefault_emptyTrue" ~ "DecontX_background",
                             T ~ method)) 

saveRDS(df_eval_metrics, "Extra_analyses/benchmark_metrics.RDS")
``` 


## SUMMARIZE RESULTS

```{r summarize_results}
df_eval_metrics <- readRDS("Extra_analyses/benchmark_metrics.RDS")

df_zscore_perRep <- df_eval_metrics %>% 
  # Reverse metrics for which low value = better
  mutate(delta = ifelse(metric %in% c("rmsle", "expression_fraction"), -delta, delta)) %>% 
  # Remove estimation accuracy for parameter settings in which the contamination fraction has to be set  
  #filter(!(evaluation_category == "estimation_accuracy" & grepl("cont0",param))) %>% 
  #filter(method!="raw") %>%
  group_by(metric, replicate) %>% 
  mutate(mean=mean(delta, na.rm = T),
         sd=sd(delta, na.rm = T),
         dist_to_mean = delta-mean,
         zscore = dist_to_mean/sd)

df_zscore_overall <- df_zscore_perRep %>%
  group_by(method, param, evaluation_category, default, metric) %>% 
  summarise(mean_zscore = mean(zscore))


# Across default methods only
df_zscore_perRep_default <- df_eval_metrics %>% 
  # Reverse metrics for which low value = better
  mutate(delta = ifelse(metric %in% c("rmsle", "expression_fraction"), -delta, delta)) %>% 
  filter(default == T) %>%
  group_by(metric, replicate) %>% 
  mutate(mean=mean(delta, na.rm = T),
         sd=sd(delta, na.rm = T),
         dist_to_mean = delta-mean,
         zscore = dist_to_mean/sd)

df_zscore_overall_default <- df_zscore_perRep_default %>%
  group_by(method, param, evaluation_category, default, metric) %>% 
  summarise(mean_zscore = mean(zscore))

```

## PLOTTING

```{r plot_raw results, fig.width=12,fig.height=6}
library(ggh4x)
inp <- df_eval_metrics %>% 
  filter(default == T,
         metric %in% c("tau", "rmsle","prediction_score", "purity", "kNN_overlap", "avg_silhouette","log_ratio_expression", "lfc")) %>% 
  mutate(evaluation_category = factor(evaluation_category, levels = c("estimation_accuracy", "cluster_evaluation", "marker_evaluation")),
         method = factor(method, levels = c("CellBender","SoupX","DecontX","raw")),
         method2 = factor(method2, levels = c("CellBender","SoupX","DecontX_default","DecontX_background","raw")),
         metric_long = case_when(metric == "avg_silhouette" ~ "Average silhouette",
                                 metric == "prediction_score" ~ "Prediction score (delta)",
                                 metric == "purity" ~ "Purity",
                                 metric == "kNN_overlap" ~ "k-NN overlap",
                                 T ~ metric))

## scaled by range
p.cluster_evaluation_range <- inp %>% 
  mutate(scaled_range = case_when(metric %in% c("avg_silhouette","prediction_score") ~ delta/2,
                                  metric %in% c("purity") ~ delta,
                                  metric %in% c("kNN_overlap") ~ delta/50)) %>% 
  filter(method != "raw", evaluation_category == "cluster_evaluation") %>% 
  mutate(metric_long = factor(metric_long, levels = c("Prediction score (delta)", "Average silhouette","Purity","k-NN overlap")),
         replicate = factor(replicate, levels = rev(c("rep3", "rep1", "rep2", "nuc2")))) %>% 
  ggplot(aes(x = replicate, y = scaled_range, color = method2))+
      geom_jitter(size = 2, width = 0.1)+
      geom_hline(data = filter(inp, evaluation_category != "estimation_accuracy"), yintercept = 0, color = "black")+
      coord_flip()+
      #scale_y_continuous(limits = c(-0.5,0.5))+
      scale_color_manual(values = method_colors2, limits = force)+
      ggh4x::facet_nested(~metric_long)+
      #ggh4x::facetted_pos_scales(y = list(metric == "rmsle" ~ scale_y_reverse()))+
      theme_bw()+
      labs(y = "scaled difference to score(uncorrected)")+
          theme(axis.title.y = element_blank(), axis.text.x = element_text(size = 6), strip.background = element_rect(fill = "white"))

p.cluster_evaluation_range


# Absolute values including uncorrected
p.absolute_metrics <- inp %>% 
  filter(evaluation_category != "estimation_accuracy") %>% 
  ggplot(aes(x = replicate, y = value, color = method2))+
    geom_jitter(size = 2, width = 0.1)+
    coord_flip()+
    scale_color_manual(values = method_colors2, limits = force)+
    ggh4x::facet_nested(~evaluation_category+metric_long, scale = "free")+
    theme_bw()+
    labs(y = "absolute values")+
    theme(axis.title.y = element_blank(), axis.text.x = element_text(size = 6))

p.absolute_metrics

p.absolute_clustering <- inp %>% 
  mutate(scaled_range = case_when(metric %in% c("avg_silhouette","prediction_score") ~ delta/2,
                                  metric %in% c("purity") ~ delta,
                                  metric %in% c("kNN_overlap") ~ delta/50,)) %>% 
  filter(evaluation_category == "cluster_evaluation") %>% 
  mutate(metric_long = factor(metric_long, levels = c("Prediction score (delta)", "Average silhouette","Purity","k-NN overlap")),
          replicate = factor(replicate, levels = rev(c("rep3", "rep1", "rep2", "nuc2")))) %>% 
  ggplot(aes(x = replicate, y = value, color = method2))+
      geom_jitter(size = 2, width = 0.1)+
      coord_flip()+
      scale_color_manual(values = method_colors2, limits = force, breaks = c("raw", "CellBender","SoupX", "DecontX_default", "DecontX_background"))+
      ggh4x::facet_nested(~metric_long, scale = "free")+
      theme_bw()+
      #labs(y = "scaled difference to score(uncorrected)")+
      theme(axis.title = element_blank(), axis.text.x = element_text(size = 6), strip.background = element_rect(fill = "white"),
                legend.title = element_blank())

p.absolute_clustering

ggsave("figures/Suppl_figure_metrics_absolute.pdf", p.absolute_clustering, width = 9, height = 2.5)


# Relative values compared to uncorrected
p.relative_metrics <- inp %>% 
  filter(method != "raw") %>% 
  ggplot(aes(x = replicate, y = delta, color = method))+
      geom_jitter(size = 2, width = 0.1)+
      geom_hline(yintercept = 0, color = "black")+
      coord_flip()+
      scale_color_manual(values = method_colors, limits = force)+
      ggh4x::facet_nested(~evaluation_category+metric, scale = "free")+
      ggh4x::facetted_pos_scales(y = list(metric == "rmsle" ~ scale_y_reverse()))+
      theme_bw()+
      labs(y = "difference to uncorrected values")+
          theme(axis.title.y = element_blank(), axis.text.x = element_text(size = 6))

# zscore summary
p.zscore_metrics <- df_zscore_overall_default %>% 
  filter(default == T,
         metric %in% c("tau", "rmsle","prediction_score", "purity", "avg_silhouette","log_ratio_expression", "lfc")) %>% 
  mutate(evaluation_category = factor(evaluation_category, levels = c("estimation_accuracy", "cluster_evaluation", "marker_evaluation")),
         method = factor(method, levels = c("CellBender","DecontX","SoupX","raw"))) %>% 

  ggplot(aes(x = " ", y = mean_zscore, color = method))+
           geom_jitter(size = 3, width = 0.1)+
           coord_flip()+
          scale_color_manual(values = method_colors, limits = force)+
          ggh4x::facet_nested(~evaluation_category+metric, scale = "free")+
          theme_bw()+
          theme(axis.title.y = element_blank(), axis.text.x = element_text(size = 6))

plot_grid(p.absolute_metrics, 
          p.relative_metrics, 
          p.zscore_metrics,
          nrow = 3, align = "v", rel_heights = c(1,1,0.6))



inp %>% 
  filter(method != "raw", evaluation_category != "estimation_accuracy") %>% 
  ggplot(aes(x = replicate, y = rel_change, color = method))+
      geom_jitter(size = 2, width = 0.1)+
      geom_hline(data = filter(inp, evaluation_category != "estimation_accuracy"), yintercept = 0, color = "black")+
      coord_flip()+
      scale_color_manual(values = method_colors, limits = force)+
      ggh4x::facet_nested(~evaluation_category+metric)+
      ggh4x::facetted_pos_scales(y = list(metric == "rmsle" ~ scale_y_reverse()))+
      theme_bw()+
      labs(y = "relative improvement")+
          theme(axis.title.y = element_blank(), axis.text.x = element_text(size = 6))

# cell type identification only:
p.cluster_evaluation <- inp %>% 
  filter(method != "raw", evaluation_category == "cluster_evaluation") %>% 
  mutate(metric_long = case_when(metric == "avg_silhouette" ~ "Average silhouette",
                                 metric == "prediction_score" ~ "Prediction score (delta)",
                                 metric == "purity" ~ "Purity",
                                 metric == "kNN_overlap" ~ "k-NN overlap"),
         metric_long = factor(metric_long, levels = c("Prediction score (delta)", "Average silhouette","Purity","k-NN overlap"))) %>% 
  ggplot(aes(x = replicate, y = rel_change, color = method))+
      geom_jitter(size = 2, width = 0.1)+
      geom_hline(data = filter(inp, evaluation_category != "estimation_accuracy"), yintercept = 0, color = "black")+
      coord_flip()+
      #scale_y_continuous(limits = c(-0.5,0.5))+
      scale_color_manual(values = method_colors, limits = force)+
      ggh4x::facet_nested(~metric_long)+
      #ggh4x::facetted_pos_scales(y = list(metric == "rmsle" ~ scale_y_reverse()))+
      theme_bw()+
      labs(y = "relative improvement")+
          theme(axis.title.y = element_blank(), axis.text.x = element_text(size = 6), strip.background = element_rect(fill = "white"))

p.cluster_evaluation




# other options to plot metrics:

### difference to uncorrected
inp %>% 
  filter(method != "raw", evaluation_category == "cluster_evaluation") %>% 
  mutate(metric_long = case_when(metric == "avg_silhouette" ~ "Average silhouette",
                                 metric == "prediction_score" ~ "Prediction score (delta)",
                                 metric == "purity" ~ "Purity",
                                 metric == "kNN_overlap" ~ "k-NN overlap"),
         metric_long = factor(metric_long, levels = c("Prediction score (delta)", "Average silhouette","Purity","k-NN overlap"))) %>% 
  ggplot(aes(x = replicate, y = delta, color = method))+
      geom_jitter(size = 2, width = 0.1)+
      geom_hline(data = filter(inp, evaluation_category != "estimation_accuracy"), yintercept = 0, color = "black")+
      coord_flip()+
      #scale_y_continuous(limits = c(-0.5,0.5))+
      scale_color_manual(values = method_colors, limits = force)+
      ggh4x::facet_nested(~metric_long, scales = "free")+
      #ggh4x::facetted_pos_scales(y = list(metric == "rmsle" ~ scale_y_reverse()))+
      theme_bw()+
      labs(y = "difference to uncorrected")+
          theme(axis.title.y = element_blank(), axis.text.x = element_text(size = 6), strip.background = element_rect(fill = "white"))


inp %>% 
  filter(evaluation_category == "cluster_evaluation") %>% 
  mutate(metric_long = case_when(metric == "avg_silhouette" ~ "Average silhouette",
                                 metric == "prediction_score" ~ "Prediction score (delta)",
                                 metric == "purity" ~ "Purity",
                                 metric == "kNN_overlap" ~ "k-NN overlap"),
         metric_long = factor(metric_long, levels = c("Prediction score (delta)", "Average silhouette","Purity","k-NN overlap"))) %>% 
  ggplot(aes(x = replicate, y = value, color = method))+
      geom_jitter(size = 2, width = 0.1)+
      #geom_hline(data = filter(inp, evaluation_category != "estimation_accuracy"), yintercept = 0, color = "black")+
      coord_flip()+
      #scale_y_continuous(limits = c(-0.5,0.5))+
      scale_color_manual(values = method_colors, limits = force)+
      ggh4x::facet_nested(~metric_long, scales = "free")+
      #ggh4x::facetted_pos_scales(y = list(metric == "rmsle" ~ scale_y_reverse()))+
      theme_bw()+
      labs(y = "absolute values")+
          theme(axis.title.y = element_blank(), axis.text.x = element_text(size = 6), strip.background = element_rect(fill = "white"))

# relative, scales free
inp %>% 
  filter(method != "raw", evaluation_category == "cluster_evaluation") %>% 
  mutate(metric_long = case_when(metric == "avg_silhouette" ~ "Average silhouette",
                                 metric == "prediction_score" ~ "Prediction score (delta)",
                                 metric == "purity" ~ "Purity",
                                 metric == "kNN_overlap" ~ "k-NN overlap"),
         metric_long = factor(metric_long, levels = c("Prediction score (delta)", "Average silhouette","Purity","k-NN overlap"))) %>% 
  ggplot(aes(x = replicate, y = rel_change, color = method))+
      geom_jitter(size = 2, width = 0.1)+
      geom_hline(data = filter(inp, evaluation_category != "estimation_accuracy"), yintercept = 0, color = "black")+
      coord_flip()+
      #scale_y_continuous(limits = c(-0.5,0.5))+
      scale_color_manual(values = method_colors, limits = force)+
      ggh4x::facet_nested(~metric_long, scales = "free")+
      #ggh4x::facetted_pos_scales(y = list(metric == "rmsle" ~ scale_y_reverse()))+
      theme_bw()+
      labs(y = "relative improvement")+
          theme(axis.title.y = element_blank(), axis.text.x = element_text(size = 6), strip.background = element_rect(fill = "white"))




```

## SUB-RESULTS 

### Marker gene detection

#### Expression fraction per Gene

```{r expr_fraction}
expression_fraction_PT_markers <- readRDS(paste0("Snakemake_backup/benchmark/evaluation/CellBender/rep2/expression_fraction_PT_markers.RDS"))

l_expr_perGene <- list()
for(method in c("raw", "CellBender", "DecontX", "SoupX")){
  for(rep in c("rep1","rep2","rep3","nuc2")){ 
    expression_fraction_PT_markers <- readRDS(paste0("Snakemake_backup/benchmark/evaluation/",method,"/",rep,"/expression_fraction_PT_markers.RDS"))
    l_expr_perGene[[method]][[rep]] <- expression_fraction_PT_markers 
  }
  l_expr_perGene[[method]] <- bind_rows(l_expr_perGene[[method]], .id = "replicate")
} 

df_expr_perGene <- bind_rows(l_expr_perGene, .id = "method")

#### Limma lfcs per Gene

panglao_markers <- readRDS("/data/share/htp/CZI_kidney/mouse_experiments/backgroundRNA/files/panglao_markers_Mm.RDS")
l_lfc_perGene <- list()
for(method in c("raw", "CellBender", "DecontX", "SoupX")){
  for(rep in  c("rep1", "rep2","rep3", "nuc2")){ 
    differential_expression <- readRDS(paste0("Snakemake_backup/benchmark/evaluation/",method,"/",rep,"/differential_expression2.RDS"))
    l_lfc_perGene[[method]][[rep]] <- differential_expression %>% 
      filter(gene %in% panglao_markers)
  }
  l_lfc_perGene[[method]] <- bind_rows(l_lfc_perGene[[method]], .id = "replicate")
} 
df_lfc_perGene <- bind_rows(l_lfc_perGene, .id = "method")


# select the top PT markers
topGenes <- df_lfc_perGene %>% 
  filter(method == "raw") %>% 
  group_by(gene) %>% 
  summarize(mean_logFC = mean(logFC),
            mean_AveExpr = mean(AveExpr)) %>% 
 # arrange(desc(mean_logFC)) %>%  
  arrange(desc(mean_AveExpr)) %>%  
  pull(gene) %>% .[1:10]

saveRDS(topGenes, "Extra_analyses/top10_PT_markers.RDS")


# filter for top 10 genes
lfc_topGenes <- df_lfc_perGene %>% 
  filter(gene %in% topGenes) %>% 
  group_by(replicate, gene) %>% 
  mutate(lfc_difference = logFC - logFC[method == "raw"],
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc2"))) %>% 
  group_by(replicate, method, param) %>% 
  summarise(meanLFCdiff = mean(lfc_difference))

```

#### DE analysis with Seurat

```{r DE_seurat}
l_lfc_perGene_seurat <- list()
for(method in c("raw", "CellBender", "DecontX", "SoupX")){
  for(rep in  c("rep1", "rep2","rep3", "nuc2")){ 
    differential_expression <- readRDS(paste0("Snakemake_backup/benchmark/evaluation/",method,"/",rep,"/differential_expression_seurat.RDS"))
    l_lfc_perGene_seurat[[method]][[rep]] <- differential_expression %>% data.frame %>% 
       rownames_to_column("gene") %>% 
       mutate(gene = gsub("\\..*", "", gene)) %>% 
       dplyr::filter(gene %in% panglao_markers)
  }
  l_lfc_perGene_seurat[[method]] <- bind_rows(l_lfc_perGene_seurat[[method]], .id = "replicate")
} 

df_lfc_perGene_seurat <- bind_rows(l_lfc_perGene_seurat, .id = "method")

saveRDS(df_lfc_perGene_seurat, "Extra_analyses/DE_seurat.RDS")


# All significant up genes
l_lfc_perGene_seurat <- list()
for(method in c("raw", "CellBender", "DecontX", "SoupX")){
  for(rep in  c("rep1", "rep2","rep3", "nuc2")){ 
    differential_expression <- readRDS(paste0("Snakemake_backup/benchmark/evaluation/",method,"/",rep,"/differential_expression_seurat.RDS"))
    l_lfc_perGene_seurat[[method]][[rep]] <- differential_expression %>% data.frame %>% 
       rownames_to_column("gene") %>% 
       mutate(gene = gsub("\\..*", "", gene)) #%>% 
       #dplyr::filter(gene %in% panglao_markers)
  }
  l_lfc_perGene_seurat[[method]] <- bind_rows(l_lfc_perGene_seurat[[method]], .id = "replicate")
} 

df_lfc_perGene_seurat <- bind_rows(l_lfc_perGene_seurat, .id = "method") %>% 
  left_join(dplyr::select(df_eval_metrics, c(method,replicate, param,default,method2))) %>%
  filter(default == T) %>% 
  distinct() %>% 
  mutate(sigUP = p_val_adj < 0.05 & avg_log2FC > 0 ,
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc2"))) %>% 
  group_by(replicate, gene) %>% 
  filter(sum(sigUP) > 0) %>% 
  ungroup()

saveRDS(df_lfc_perGene_seurat, "Extra_analyses/DE_seurat_sigUP.RDS")

```


#### Plotting: PT marker heatmap

```{r marker_heatmap}
marker_plot_inp <- lapply(setNames(c("rep1", "rep2","rep3", "nuc2"), c("rep1", "rep2","rep3", "nuc2")), function(rep){ 
  cormat_list <- list(raw = readRDS(paste0("Snakemake_backup/benchmark/corrected/raw/",rep,"/raw_cormat.RDS")),
                      CellBender = readRDS(paste0("Snakemake_backup/benchmark/corrected/CellBender/",rep,"/fpr0.01_total25000_cormat.RDS")),
                      DecontX_default = readRDS(paste0("Snakemake_backup/benchmark/corrected/DecontX/",rep,"/resDefault_emptyFalse_cormat.RDS")),
                      DecontX_background = readRDS(paste0("Snakemake_backup/benchmark/corrected/DecontX/",rep,"/resDefault_emptyTrue_cormat.RDS")),
                      SoupX = readRDS(paste0("Snakemake_backup/benchmark/corrected/SoupX/",rep,"/res1_contAuto_cormat.RDS")))
  
  marker_df <- lapply(cormat_list, function(cor_mat){
     cor_mat[topGenes,] %>% t() %>% data.frame() %>% rownames_to_column("cell") %>% 
      pivot_longer(cols = -cell, names_to = "gene", values_to = "expr") %>% 
      mutate(log_expr = log10(expr+1)) %>% 
      inner_join(cell_sample)
  }) %>% bind_rows(.id = "method")
  return(marker_df)
}) %>% bind_rows(.id = "replicate")
  

p.PT_heatmap_methods <- marker_plot_inp %>% 
  mutate(method = factor(method, levels = c("raw", "CellBender", "SoupX", "DecontX_default", "DecontX_background")),
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc2")),
         gene = factor(gene, levels = rev(topGenes)),
         isPT = factor(isPT, levels = c("PT", "not PT"))) %>% 
  ggplot(aes(x = cell, y = gene, fill = log_expr))+
          geom_tile()+
          ggh4x::facet_nested(method~replicate+isPT, scale = "free", space = "free")+
          #facet_grid(~isPT, scales = "free", space = "free_x")+
          theme_bw()+
          scale_fill_gradient(low = "lightgrey", high = "red")+
          scale_x_discrete(position = "top")+ 
          theme(legend.position = "top", axis.text.y = element_text(size = 7), axis.title = element_blank(),
                legend.box.margin=margin(-10,-10,-10,-10), axis.text.x = element_blank(), axis.ticks.x = element_blank(),
                strip.background = element_rect(fill = "white"), strip.text.y =  element_text(size = 7))

p.PT_heatmap_methods
```


#### Plotting: DE metrics for top PT markers

```{r}
# expression fraction
p.expr_frac_topGenes <- df_expr_perGene %>% 
  mutate(default = (method == "CellBender" & param == "fpr0.01_total25000" |
                    method == "DecontX" & param == "resDefault_emptyFalse" |
                    method == "DecontX" & param == "resDefault_emptyTrue" |
                    method == "SoupX" & param == "res1_contAuto" |
                    method == "raw"),
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc3", "nuc2")),
         method2 = case_when(method == "DecontX" & param == "resDefault_emptyFalse" ~ "DecontX_default",
                             method == "DecontX" & param == "resDefault_emptyTrue" ~ "DecontX_background",
                             T ~ method))  %>% 
  #left_join(dplyr::select(df_eval_metrics, c(method,replicate, param,default))) %>% 
  #distinct() %>% 
  filter(gene %in% topGenes, default == T) %>% 
  mutate(gene = factor(gene, levels = rev(topGenes)),
         replicate = factor(replicate, levels = rev(c("rep3", "rep1", "rep2", "nuc2"))),
         method2 = factor(method2, levels = rev(c("raw", "CellBender","SoupX", "DecontX_default", "DecontX_background")))) %>%

  ggplot(aes(x = replicate, y = expr_within_others, fill = method2))+
    geom_boxplot(alpha = 0.8, outlier.size = 0.1)+
    scale_fill_manual(values = method_colors2, limits = force, breaks = c("raw", "CellBender","SoupX", "DecontX_default", "DecontX_background"))+
    coord_flip()+
    theme_bw()+
    theme(axis.title.y = element_blank(), legend.position = "none")+
    labs(y = "Expression fraction in non-PT cells")

# log FC limma
p.limma_lfc_topGenes <- df_lfc_perGene %>% 
  left_join(select(df_eval_metrics, c(method,replicate, param,default))) %>% 
  distinct() %>% 
  filter(gene %in% topGenes, default == T) %>% 
  mutate(gene = factor(gene, levels = rev(topGenes)),
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc2")),
         method = factor(method, levels = c("raw", "CellBender", "DecontX", "SoupX"))) %>% 

  ggplot(aes(x = replicate, y = logFC, fill = method))+
    geom_boxplot(alpha = 0.8)+
    scale_fill_manual(values = method_colors, limits = force)+
    theme_bw()+
    theme(axis.title.x = element_blank(),  legend.position = "none")+
    labs(y = "log2FC (limma-trend)")



# Seurat lfcs
p.seurat_lfc_topGenes <- df_lfc_perGene_seurat %>% 
  mutate(default = (method == "CellBender" & param == "fpr0.01_total25000" |
                    method == "DecontX" & param == "resDefault_emptyFalse" |
                    method == "DecontX" & param == "resDefault_emptyTrue" |
                    method == "SoupX" & param == "res1_contAuto" |
                    method == "raw"),
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc3", "nuc2")),
         method2 = case_when(method == "DecontX" & param == "resDefault_emptyFalse" ~ "DecontX_default",
                             method == "DecontX" & param == "resDefault_emptyTrue" ~ "DecontX_background",
                             T ~ method))  %>% 
  filter(gene %in% topGenes, default == T) %>% 
  mutate(gene = factor(gene, levels = rev(topGenes)),
         replicate = factor(replicate, levels = rev(c("rep3", "rep1", "rep2", "nuc2"))),
         method2 = factor(method2, levels = rev(c("raw", "CellBender","SoupX", "DecontX_default", "DecontX_background")))) %>%

  ggplot(aes(x = replicate, y = avg_log2FC, fill = method2))+
    geom_boxplot(alpha = 0.8, outlier.size = 0.1)+
    scale_fill_manual(values = method_colors2, limits = force, breaks = c("raw", "CellBender","SoupX", "DecontX_default", "DecontX_background"))+
    coord_flip()+
    theme_bw()+
    theme(axis.title.y = element_blank(), legend.position = "none")+
    labs(y = "log2FC")


p.DE_metrics <- plot_grid(p.expr_frac_topGenes, p.limma_lfc_topGenes, p.seurat_lfc_topGenes, 
          nrow = 1, labels = c("B","C","D"))

method_legend


p.topMarkers_methods <- plot_grid(p.PT_heatmap_methods, p.DE_metrics, 
          nrow = 2, rel_heights = c(1.7,1), labels = c("A",""))

ggsave("figures/Suppl_figure_topMarkersEval.pdf", p.topMarkers_methods, width = 10, height = 9)


### lfc scatterplot vs uncorrected
tmp <- df_lfc_perGene_seurat %>% 
  filter(method == "raw") %>% 
  mutate(avg_log2FC_uncorrected = avg_log2FC) %>% 
  select(replicate, gene, avg_log2FC_uncorrected) %>% 
  right_join(df_lfc_perGene_seurat)

tmp %>% 
  filter(method != "raw",
         gene %in% panglao_markers) %>% 
  ggplot(aes(x = avg_log2FC_uncorrected, y = avg_log2FC, color = method))+
    geom_point(alpha = 0.6)+
    scale_color_manual(values = method_colors, limits = force)+
    geom_abline(slope = 1)+
    facet_grid(~replicate)+
    theme_bw()

```

#### 10 Panglao marker supplement

```{r pangla_suppl}
panglao_markers <- readRDS("/data/share/htp/CZI_kidney/mouse_experiments/backgroundRNA/files/panglao_markers_Mm.RDS") 
sigSEU<- readRDS("Extra_analyses/DE_seurat_sigUP.RDS")  %>% 
  group_by(method2,replicate) %>% 
  mutate( rnk = dense_rank(-avg_log2FC),
          panglao = gene %in% panglao_markers) %>% 
  group_by(replicate,gene) %>% 
  mutate( Minrnk = min(rnk)) %>% ungroup 

sigSEU$method2<-factor(sigSEU$method2, levels=c("raw","CellBender","SoupX","DecontX_default","DecontX_background"))

top10.seu_panglao<-sigSEU %>% filter( panglao & rnk<=10) %>% 
  ggplot(aes(x=method2,  fill=method2)) +
  geom_bar() +
  scale_fill_manual(values=method_colors2, limits = force)+
  facet_grid(. ~ replicate) + coord_flip() +theme_bw()+ 
  ylab("overlap of top10 LFC genes with panglao markers")+
  theme(axis.title.y = element_blank(), legend.position =  "None")

####################################################################
tmp<-sigSEU %>% filter(Minrnk<=100) %>% dplyr::transmute(method=method2, replicate, gene, panglao, avg_log2FC)
  
tmp2<-inner_join( tmp %>% filter(method !="raw") , 
            tmp %>% filter(method == "raw") %>% dplyr::select(-method),
            by = c("replicate","gene","panglao"),
            suffix = c("","_raw"))

top100cor<-tmp2 %>% ggplot( aes(x=avg_log2FC_raw, y=avg_log2FC,col=method)) +
  geom_abline(intercept=0,slope=1,lty=1,col="black")+
  geom_point(alpha=0.5)+ stat_smooth(method = "lm",se = F)+
  scale_color_manual(values=method_colors2, limits = force)+
  facet_grid(. ~ replicate) + theme_bw()+
  xlab("log2-fold-change uncorrected") +
  ylab("log2-fold-change corrected")+
  theme(legend.position = "bottom", legend.title = element_blank())


plot_grid(top10.seu_panglao,top100cor, nrow = 2, align="v", axis="l" )
```


```{r suppl_figure_markers}
p.topMarkers_suppl <- plot_grid(p.PT_heatmap_methods,
                                top10.seu_panglao,
                                top100cor,
          nrow = 3, rel_heights = c(2.3,0.8,1), labels = c("A","B","C"),
          align = "v", axis = "l")

p.topMarkers_suppl

ggsave("figures/Suppl_figure_topMarkersEval.pdf", p.topMarkers_suppl, width = 10, height = 11)

```



#### Slc34a1 example

```{r expr_frac}
Slc34_expr_frac <- df_expr_perGene %>% 
  left_join(dplyr::select(df_eval_metrics, c(method,replicate, param,default))) %>% 
  distinct() %>% 
  filter(gene == "Slc34a1", default == T) %>% 
  mutate(replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc2")))

saveRDS(Slc34_expr_frac, "Extra_analyses/Slc34a1_expression_fraction.RDS")
  
p.expr_frac_slc34a1 <- ggplot(Slc34_expr_frac, aes(x = replicate, y = expr_within_others, color = method))+
     geom_point(size = 3, position = position_dodge(width = .2))+
  coord_flip()+
  scale_color_manual(values = method_colors, limits = force)+
  theme_bw()+
  theme(axis.title.y = element_blank(), legend.position = "none",axis.text.y = element_text(size = 13))+
  labs(y = "Expression fraction in non-PT cells")

p.lfc_slc34a1 <- df_lfc_perGene_seurat %>% 
  filter(gene == "Slc34a1") %>% 
  mutate(method = factor(method, levels = c("raw", "CellBender", "DecontX", "SoupX"))) %>% 
  ggplot( aes(x = replicate, y = avg_log2FC, color = method))+
     geom_point(size = 3, position = position_dodge(width = .2))+
    coord_flip()+
    scale_color_manual(values = method_colors, limits = force)+
    theme_bw()+
    theme(axis.title.y = element_blank(), legend.position = "none", axis.text.y = element_text(size = 13))+
    labs(y = "log2FC")

p.slc34a1_benchmark <- plot_grid(p.expr_frac_slc34a1, p.lfc_slc34a1, 
          get_legend(p.lfc_slc34a1+theme(legend.position = "right", legend.title = element_blank())),
          nrow = 1, rel_widths = c(1,1,0.4), labels = c("C","D"))

plot_grid(p.UMAPs_ct_slc, 
          p.slc34a1_benchmark,
          nrow = 2, rel_heights = c(1,0.5))


```

#### Marker ranking

```{r marker_ranking}
sigSEU<- readRDS("Extra_analyses/DE_seurat_sigUP.RDS")  %>% 
    group_by(method,replicate) %>% 
  mutate( rnk = dense_rank(-avg_log2FC),
          panglao = gene %in% panglao_markers) %>% 
  group_by(replicate,gene) %>% 
  mutate( Minrnk = min(rnk)) %>% ungroup

topGenes<-readRDS("Extra_analyses/top10_PT_markers.RDS")


sigSEU %>%   filter(gene %in% topGenes) %>% 
  ggplot(aes(x=method, y=rnk, fill=method)) +
  geom_quasirandom(shape=21,alpha=0.7) +
  scale_y_log10() +
  geom_hline(yintercept = 10, col="grey" )+
  scale_fill_manual(values=method_colors, limits = force)+
  facet_grid(. ~ replicate) + coord_flip() +theme_bw()
```


#### Log2 fold changes

```{r lfcs}
# lfc distribution
p.lfc_histogram <- df_lfc_perGene_seurat %>% 
  mutate(method = factor(method, levels = c("raw", "CellBender", "DecontX", "SoupX")),
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc2"))) %>% 
  filter(avg_log2FC > 1) %>%
  mutate(lfc_cat = case_when(avg_log2FC > 1 & avg_log2FC <=2 ~ "(1,2]",
                              avg_log2FC > 2 & avg_log2FC <=3 ~ "(2,3]",
                              avg_log2FC > 3 & avg_log2FC <=4 ~ "(3,4]",
                              avg_log2FC > 4 & avg_log2FC <=5 ~ "(4,5]",
                              avg_log2FC > 5 ~ "(5,Inf]" )) %>% 
  ggplot(aes(x = lfc_cat, fill = method))+
    #geom_density(alpha = 0.4)+
    geom_bar(position = position_dodge2(preserve = "single"))+
    facet_grid(~replicate)+
    scale_fill_manual(values = method_colors, limits = force)+
    theme_bw()+
    theme(legend.position = c(0.93,0.7), legend.title = element_blank())+
    labs(x = "log2FC bin")


# Barcode plot of panglao markers
p.panglao_barcodes <- df_lfc_perGene_seurat %>% 
  filter(gene %in% panglao_markers) %>% 
  mutate(method = factor(method, levels = rev(c("raw", "CellBender", "DecontX", "SoupX"))),
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc2"))) %>% 
  ggplot(aes(x = avg_log2FC, y = method, color = method))+
    geom_point(shape = 124, size = 3)+
    facet_grid(~replicate)+
  scale_color_manual(values = method_colors, limits = force)+
  theme_bw()+
  theme(axis.title.y = element_blank(), legend.position = "none")+
  labs(x = "log2FC")

p.panglao_barcodes

plot_grid(p.lfc_histogram, p.panglao_barcodes, 
          nrow = 2, align = "v", rel_heights = c(1.5,1))

```


#### Additional plots

```{r }
# Additional plots
plot_grid(
  lfc_topGenes %>% 
  left_join(select(df_eval_metrics, c(method,replicate, param,default))) %>% 
  filter(default == T) %>% 
  distinct() %>% 
  
  ggplot(aes(x = replicate, y = meanLFCdiff, color = method))+
    geom_point(size = 3)+
  scale_color_manual(values = method_colors)+
  theme_bw()+
  coord_flip(),
  
  df_eval_metrics%>% 
  filter(default == T, metric == "lfc") %>% 
  distinct() %>% 
  
  ggplot(aes(x = replicate, y = delta, color = method))+
    geom_point(size = 3)+
  scale_color_manual(values = method_colors)+
  theme_bw()+
  coord_flip(),
  
  nrow = 1
)


View(tmp)





l_lfc_perGene2 <- list()
for(method in c("raw", "CellBender", "DecontX", "SoupX")){
  for(rep in  c("rep1", "rep2","rep3", "nuc2")){ 
    differential_expression <- readRDS(paste0("Snakemake_backup/benchmark/evaluation/",method,"/",rep,"/differential_expression2.RDS"))
    l_lfc_perGene2[[method]][[rep]] <- differential_expression %>% 
      filter(gene %in% panglao_markers)
  }
  l_lfc_perGene2[[method]] <- bind_rows(l_lfc_perGene2[[method]], .id = "replicate")
} 

df_lfc_perGene2 <- bind_rows(l_lfc_perGene2, .id = "method")



p.top10_lfc <- df_lfc_perGene2 %>% 
  left_join(select(df_eval_metrics, c(method,replicate, param,default))) %>% 
  distinct() %>% 
  filter(gene %in% topGenes, default == T) %>% 
  mutate(gene = factor(gene, levels = topGenes),
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc2"))) %>% 

  ggplot(aes(x = replicate, y = logFC, color = method))+
    geom_jitter(size = 2, width = 0.2)+
    coord_flip()+
    scale_color_manual(values = method_colors)+
    facet_grid(~gene)+
    theme_bw()

p.top10_lfc_all <- df_lfc_perGene %>% 
  left_join(select(df_eval_metrics, c(method,replicate, param,default))) %>% 
  distinct() %>% 
  filter(gene %in% topGenes, default == T) %>% 
  mutate(gene = factor(gene, levels = topGenes),
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc2"))) %>% 

  ggplot(aes(x = replicate, y = logFC, color = method))+
    geom_jitter(size = 2, width = 0.2)+
    coord_flip()+
    scale_color_manual(values = method_colors)+
    facet_grid(~gene)+
    theme_bw()

p.top10_expr_frac <- df_expr_perGene2 %>% 
  left_join(select(df_eval_metrics, c(method,replicate, param,default))) %>% 
  distinct() %>% 
  filter(gene %in% topGenes, default == T) %>% 
  mutate(gene = factor(gene, levels = topGenes),
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc2"))) %>% 

  ggplot(aes(x = replicate, y = expr_within_others, color = method))+
    geom_jitter(size = 2, width = 0.2)+
    coord_flip()+
    scale_color_manual(values = method_colors, limits = force)+
    facet_grid(~gene)+
    theme_bw()

plot_grid(p.top10_lfc, p.top10_expr_frac, nrow = 2, align = "v")



# plot heatmap of top10 marker genes in different replicates
cell_metadata <- readRDS("Extra_analyses/cell_metadata.RDS")

cell_sample <- cell_metadata %>% 
  filter(Strain == "CAST", !is.na(celltype), replicate != "nuc3") %>% 
  mutate(isPT = ifelse(celltype == "PT", "PT", "not PT")) %>% 
  group_by(replicate, isPT) %>% 
  slice_sample(n = 100)



cor_mat <- readRDS("Snakemake_backup/benchmark/corrected/CellBender/nuc2/fpr0.01_total25000_cormat.RDS")

CB_df <- cor_mat[topGenes,] %>% t() %>% data.frame() %>% rownames_to_column("cell") %>% 
  pivot_longer(cols = -cell, names_to = "gene", values_to = "expr") %>% 
  mutate(log_expr = log10(expr+1)) %>% 
  inner_join(cell_sample)


ggplot(CB_df, aes(x = cell, y = gene, fill = log_expr))+
        geom_tile()+
        facet_grid(~isPT, scales = "free", space = "free_x")+
        theme_bw()+
        scale_fill_gradient(low = "lightgrey", high = "red")+
        scale_x_discrete(position = "top")+ 
        theme(legend.position = "top", axis.text.y = element_text(size = 7), axis.title = element_blank(),
              legend.box.margin=margin(-10,-10,-10,-10), axis.text.x = element_blank(), axis.ticks.x = element_blank())

## seurat lfcs
df_lfc_perGene_seurat %>% 
  left_join(select(df_eval_metrics, c(method,replicate, param,default))) %>% 
  distinct() %>% 
  filter(gene %in% topGenes, default == T) %>% 
  mutate(gene = factor(gene, levels = rev(topGenes)),
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc2"))) %>% 

  ggplot(aes(x = gene, y = avg_log2FC, color = method))+
    geom_jitter(size = 2, width = 0.2)+
    coord_flip()+
    scale_color_manual(values = method_colors, limits = force)+
    facet_grid(replicate~., scale = "free")+
    theme_bw()

df_lfc_perGene_seurat %>% 
  left_join(select(df_eval_metrics, c(method,replicate, param,default))) %>% 
  distinct() %>% 
  filter(gene %in% topGenes, default == T) %>% 
  mutate(gene = factor(gene, levels = rev(topGenes)),
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc2"))) %>% 

  ggplot(aes(x = replicate, y = avg_log2FC, color = method))+
    geom_jitter(size = 2, width = 0.2)+
    #coord_flip()+
    scale_color_manual(values = method_colors, limits = force)+
    facet_grid(~gene, scale = "free")+
    theme_bw()


### Expression fraction per replicate after correction
df_eval_metrics %>% 
  filter(metric %in% c("expression_fraction"),
         default == T) %>% 
  mutate(metric_pretty = case_when(metric == "expression_fraction" ~ "Expression fraction in non-PT cells",
                            metric == "prediction_score" ~ "classification \n score",
                            metric == "purity" ~ "cluster purity",
                            metric == "avg_silhouette" ~ "silhouette",
                            metric == "tau" ~ "Kendall's tau",
                            metric == "rmsle" ~ "RMSLE",
                            metric == "lfc" ~ "change in \n log fold change",
                            T ~ metric)) %>% 
  ggplot(aes(x = method, y = value, color = replicate))+
  geom_point(size = 2, position = position_dodge(width = .5))+
  coord_flip()+
  geom_hline(yintercept = 0, color = "black")+
  scale_color_manual(values = replicate_colors)+
  facet_grid(~metric_pretty, scales = "free")+
  theme_bw()+
  theme(axis.title = element_blank())
```


### k-NN overlap

Get cleaned matrix: 

```{r cleaned_matrix}
kNN_list <- readRDS("Extra_analyses/kNN_list_allGenes.RDS")

# df_kNN <- lapply(setNames(c("rep1","rep2","rep3","nuc2"), c("rep1","rep2","rep3","nuc2")), function(rep){
#   lapply(setNames(c("raw","CellBender","DecontX","SoupX"), c("raw","CellBender","DecontX","SoupX")), function(x){
#     calculate_kNN_overlap(kNN_list[[rep]]$ref, kNN_list[[rep]][[x]])
#   }) %>% bind_rows(.id = "method")
# }) %>% bind_rows(.id = "replicate")

calculate_kNN_overlap <- function(ref_kNN, test_kNN){
  mean(sapply(seq_len(nrow(test_kNN)), function(cell_idx){
    length(intersect(ref_kNN[cell_idx,], test_kNN[cell_idx,]))}))
}



df_kNN_param <- lapply(kNN_list, function(x){
  lapply(setNames(c("raw","CellBender","DecontX","SoupX"), c("raw","CellBender","DecontX","SoupX")), function(method){
    calculate_kNN_overlap(x$ref, x[[method]])
  }) %>% bind_rows(.id = "method")
}) %>% bind_rows(.id = "name")

df_kNN_param_long <- df_kNN_param %>% pivot_longer(cols = -name, values_to = "kNN_overlap", names_to = "method") %>% 
  mutate(method = factor(method, levels = c("raw", "CellBender", "DecontX", "SoupX"))) %>% 
  group_by(name) %>% 
  mutate(relative_change = (kNN_overlap - kNN_overlap[method == "raw"]) / kNN_overlap[method == "raw"],
         absolute_change = kNN_overlap - kNN_overlap[method == "raw"],
         replicate = word(name,1,1,sep="_"),
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc2")),
         k = word(name,2,2,sep="_"),
         relative_change2 = (kNN_overlap - kNN_overlap[method == "raw"]) / as.numeric(k),
         ndim = word(name,3,3,sep="_"))


k_colors <- setNames(c("cadetblue1", "deepskyblue1", "deepskyblue4", "darkblue"),c(10,20,50,100))

k_colors <- setNames(c("grey60", "grey40", "grey20", "grey10"),c(10,20,50,100))

k_colors <- setNames(c("lightblue", "darkblue", "lightgreen", "darkgreen"),c(10,20,50,100))

ggplot(df_kNN_param_long, aes(x = method, y= relative_change2, color = k, shape = ndim))+
  geom_hline(yintercept = 0)+
    geom_jitter(size = 2, width = 0.2)+
    coord_flip()+
  scale_color_manual (values = k_colors)+
  facet_grid(replicate~., scales = "free")+
    theme_bw()#+
  theme(legend.position = "none")

plot_grid(
df_kNN_param_long  %>% 
  filter(ndim == 30, replicate != "nuc2") %>%
  ggplot(aes(x = method, y= kNN_overlap, color = method))+
      geom_point(size = 2)+
      coord_flip()+
    scale_color_manual (values = method_colors)+
    facet_grid(replicate~k, scales = "free")+
      theme_bw()+
    theme(legend.position = "none", axis.title.x = element_blank()),

df_kNN_param_long  %>% 
  filter(ndim == 30, replicate == "nuc2") %>%
  ggplot(aes(x = method, y= kNN_overlap, color = method))+
      geom_point(size = 2)+
      coord_flip()+
    scale_color_manual (values = method_colors)+
    facet_grid(replicate~k, scales = "free")+
      theme_bw()+
    theme(legend.position = "none"),

nrow = 2, rel_heights = c(2.3,1), align = "v"
)


df_kNN_param_long_allGenes <- df_kNN_param_long

# relative change, k= 50, ndim = 30
p.genes_match <- df_kNN_param_long %>% 
  filter(k ==50, ndim == 30,
         method != "raw") %>% 

  ggplot(aes(x = replicate, y= absolute_change, color = method))+
    geom_hline(yintercept = 0)+
      geom_jitter(size = 3, width = 0.2)+
      coord_flip()+
    scale_color_manual (values = method_colors, limits = force)+
    #facet_grid(replicate~., scales = "free")+
      theme_bw()+
    theme(axis.title.y = element_blank())+
    labs(y = "Change in kNN overlap")

p.allGenes <- df_kNN_param_long_allGenes %>% 
  filter(k ==50, ndim == 30,
         method != "raw") %>% 

  ggplot(aes(x = replicate, y= kNN_overlap, color = method))+
    geom_hline(yintercept = 0)+
      geom_jitter(size = 3, width = 0.2)+
      coord_flip()+
    scale_color_manual (values = method_colors, limits = force)+
    #facet_grid(replicate~., scales = "free")+
      theme_bw()+
    labs(y = "Change in kNN overlap")

p.genes_match | p.allGenes



p.genes_match <- df_kNN_param_long %>% 
  filter(k ==50, ndim == 30) %>% 

  ggplot(aes(x = replicate, y= kNN_overlap, color = method))+
    geom_hline(yintercept = 0)+
      geom_jitter(size = 3, width = 0.2)+
      coord_flip()+
    scale_color_manual (values = method_colors, limits = force)+
    #facet_grid(replicate~., scales = "free")+
      theme_bw()+
    labs(y = "Change in kNN overlap")

p.allGenes <- df_kNN_param_long_allGenes %>% 
  filter(k ==50, ndim == 30) %>% 

  ggplot(aes(x = replicate, y= kNN_overlap, color = method))+
    geom_hline(yintercept = 0)+
      geom_jitter(size = 3, width = 0.2)+
      coord_flip()+
    scale_color_manual (values = method_colors, limits = force)+
    #facet_grid(replicate~., scales = "free")+
      theme_bw()+
    labs(y = "Change in kNN overlap")

p.genes_match | p.allGenes


### raw as reference
df_kNN_param_raw <- lapply(kNN_list, function(x){
  lapply(setNames(c("CellBender","DecontX","SoupX"), c("CellBender","DecontX","SoupX")), function(method){
    calculate_kNN_overlap(x$raw, x[[method]])
  }) %>% bind_rows(.id = "method")
}) %>% bind_rows(.id = "name")

df_kNN_param_long_raw <- df_kNN_param_raw %>% pivot_longer(cols = -name, values_to = "kNN_overlap", names_to = "method") %>% 
  mutate(method = factor(method, levels = c("CellBender", "DecontX", "SoupX"))) %>% 
  group_by(name) %>% 
  mutate(replicate = word(name,1,1,sep="_"),
         replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc2")),
         k = word(name,2,2,sep="_"),
         #relative_change2 = (kNN_overlap - kNN_overlap[method == "raw"]) / as.numeric(k),
         ndim = word(name,3,3,sep="_"))


p.genes_match <- df_kNN_param_long_raw %>% 
  filter(k ==50, ndim == 30,
         method != "raw") %>% 

  ggplot(aes(x = replicate, y= kNN_overlap, color = method))+
    geom_hline(yintercept = 0)+
      geom_jitter(size = 3, width = 0.2)+
      coord_flip()+
    scale_color_manual (values = method_colors, limits = force)+
    #facet_grid(replicate~., scales = "free")+
      theme_bw()+
    labs(y = "Change in kNN overlap")

p.allGenes <- df_kNN_param_long_allGenes %>% 
  filter(k ==50, ndim == 30,
         method != "raw") %>% 

  ggplot(aes(x = replicate, y= kNN_overlap, color = method))+
    geom_hline(yintercept = 0)+
      geom_jitter(size = 3, width = 0.2)+
      coord_flip()+
    scale_color_manual (values = method_colors, limits = force)+
    #facet_grid(replicate~., scales = "free")+
      theme_bw()+
    labs(y = "Change in kNN overlap")

p.genes_match | p.allGenes

### In PT cells vs other cells
### Filter for PT cells
kNN_list <- readRDS("Extra_analyses/kNN_list_allGenes.RDS")

l_PT <- list()
l_other <- list()


for(rep in c("rep1","rep2","rep3","nuc2")){
  seu_CAST <- readRDS(paste0("Snakemake_backup/input/",rep,"/seurat_CAST.RDS"))
  matrices <- readRDS(paste0("/data/share/htp/CZI_kidney/mouse_experiments/backgroundRNA/deconvolution_new/raw_inputs_mat/",rep,"_BCxGene_matrices_allstrains.RDS"))
  cells <- intersect(colnames(seu_CAST), colnames(matrices$endo))
  isPT <- seu_CAST[,cells]$celltype == "PT"
  
  kNN_PT <- lapply(kNN_list[[paste0(rep, "_50_30")]], function(x)x[isPT,])
  kNN_other <-  lapply(kNN_list[[paste0(rep, "_50_30")]], function(x)x[!isPT,])
  
  
  l_PT[[rep]] <- lapply(setNames(c("CellBender","DecontX","SoupX"), c("CellBender","DecontX","SoupX")), function(method){
      calculate_kNN_overlap(kNN_PT$raw, kNN_PT[[method]])
    }) %>% bind_rows(.id = "method") %>% pivot_longer(cols = everything(), values_to = "kNN_overlap", names_to = "method") %>% 
    mutate(method = factor(method, levels = c("CellBender", "DecontX", "SoupX")))
  
  l_other[[rep]] <- lapply(setNames(c("CellBender","DecontX","SoupX"), c("CellBender","DecontX","SoupX")), function(method){
      calculate_kNN_overlap(kNN_other$raw, kNN_other[[method]])
    }) %>% bind_rows(.id = "method") %>% pivot_longer(cols = everything(), values_to = "kNN_overlap", names_to = "method") %>% 
    mutate(method = factor(method, levels = c("CellBender", "DecontX", "SoupX")))
  
}

tmp <- bind_rows(list(
  PT = bind_rows(l_PT, .id = "replicate"),
  other = bind_rows(l_other, .id = "replicate")
), .id = "celltype") %>% 
  mutate(replicate = factor(replicate, levels = c("rep3","rep1", "rep2", "nuc2")))

ggplot(tmp, aes(x = replicate, y= kNN_overlap, fill = method, alpha = celltype))+
    geom_hline(yintercept = 0)+
      geom_jitter(size = 3, width = 0.2, shape = 21)+
      coord_flip()+
    scale_fill_manual (values = method_colors, limits = force)+
  scale_alpha_manual(values = c(0.4,1))+
    #facet_grid(replicate~., scales = "free")+
      theme_bw()+
    labs(y = "Change in kNN overlap")

```


### Estimation accuracy


#### Global per cell estimation

```{r estimation_accuracy}
# **** Global estimates of background RNA per cell #####
### Import per cell estimates of different methods
perCell_methods <- list()
for(rep in c("rep1", "rep2","rep3", "nuc2", "nuc3")){ 
  for(method in c("DecontX", "SoupX", "CellBender")){
    for(param in gsub("_contPerCell.RDS", "", list.files(paste0("Snakemake_backup/benchmark/corrected/",method,"/",rep), pattern = "_contPerCell"))){
      perCell_methods[[rep]][[method]][[param]] <- readRDS(paste0("Snakemake_backup/benchmark/corrected/",method,"/",rep,"/",param,"_contPerCell.RDS"))
      #perCell_methods[[rep]][[method]][[param]] <- bind_rows(perCell_methods[[rep]][[method]], .id = "parameters")
    }
    perCell_methods[[rep]][[method]] <- bind_rows(perCell_methods[[rep]][[method]], .id = "param")
  }
  method_est <- bind_rows(perCell_methods[[rep]], .id = "method")
  gt_est <- readRDS(paste0("Snakemake_backup/genotype_estimation/",rep,"/perCell_noMito_CAST_binom.RDS")) %>% 
    ungroup() %>% 
    mutate(method = "Genotype estimate", replicate = rep, param = "Genotype estimate", cont = contPerCell_binom) %>% 
    dplyr::select(method,replicate,param,cell,cont)
  seurat <- readRDS(paste0("Snakemake_backup/input/",rep,"/seurat_CAST.RDS"))
  
  perCell_methods[[rep]] <- bind_rows(method_est, gt_est) %>% filter(cell %in% colnames(seurat))
}

perCell_methods_df <- perCell_methods %>% bind_rows(.id = "replicate") %>% 
  #left_join(param_selection %>% dplyr::rename("parameters" = "param")) %>% 
  left_join(dplyr::select(df_eval_metrics, c(method,param,default))) %>% 
  mutate(method2 = case_when(method == "DecontX" & param == "resDefault_emptyFalse" ~ "DecontX_default",
                            method == "DecontX" & param == "resDefault_emptyTrue" ~ "DecontX_background",
                            T ~ method),
         default = ifelse(method2 %in% c("DecontX_default", "DecontX_background"), T, default)) %>% 
  filter(method == "Genotype estimate" | default == T) %>% 
  #filter(method == "Genotype estimate" ) %>% 
  #filter(!grepl("cont0",parameters)) %>% 
  filter(replicate %in% c("rep3", "rep1", "rep2","nuc2","nuc3")) %>% 
  mutate(replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc3", "nuc2")),
         method2 = factor(method2, levels = c("Genotype estimate", "CellBender","SoupX", "DecontX_default", "DecontX_background"))) %>% 
  distinct()

perCell_methods_summary <- perCell_methods_df %>% 
  group_by(replicate, method) %>% 
  summarise(mean_cont = mean(cont),
            sd = sd(cont))


p.global_est <- ggplot(perCell_methods_df, aes(x = replicate, y = 100*cont,fill = method2))+
  #geom_hline(aes(yintercept = 100*median_gt), data = median_gt, color = "darkgrey")+
  geom_boxplot(outlier.color = NA)+
  scale_fill_manual(values = method_colors2, limits = force)+
  #scale_alpha_manual(values = c(0.2,1), guide = "none")+
  scale_y_continuous(limits = c(0,50))+
  #coord_flip()+
  #facet_grid(method~.)+
  theme_bw()+
  theme(axis.title.x = element_blank(), axis.text = element_text(size = 11),
        #legend.position = c(0.3,0.8), 
        legend.title = element_blank(), legend.justification = c(1,0))+
  labs(y = "% background RNA per cell")

p.global_est

```

#### RMSLE and tau

```{r est_metrics}
df_estimation_metrics <- df_eval_metrics %>% 
  filter(metric %in% c("rmsle", "tau"),
         default == T) %>% 
  select(-delta) %>% 
  pivot_wider(names_from = "metric", values_from = "value")


df_estimation_metrics <- df_est %>% 
  mutate(method = case_when(method == "DecontX" & param == "resDefault_emptyFalse" ~ "DecontX_default",
                            method == "DecontX" & param == "resDefault_emptyTrue" ~ "DecontX_background",
                            T ~ method),
         default = ifelse(method %in% c("DecontX_default", "DecontX_background") | param %in% c("fpr0.01_total25000", "res1_contAuto"), T, F)) %>% 
  filter(metric %in% c("rmsle", "tau"),
         default == T) %>% 
  pivot_wider(names_from = "metric", values_from = "value")
  


# Plot RMSLE and tau against eachother
ggplot(df_estimation_metrics, aes(x = rmsle, y = tau, color = method, shape = replicate))+
  geom_point(size = 3)+
  #scale_alpha_manual(values = c(0.2,1))+
  scale_color_manual(values = method_colors2, limits = force)+
  #facet_grid(~replicate)+
  scale_x_reverse()+
  theme_bw()+
  labs(x = "RMLSE", y = "Kendall's \u03C4")

# metrics separately
p.estimation_eval_metrics <- df_eval_metrics %>% 
  filter(metric %in% c("rmsle", "tau"),
         default == T) %>% 
  mutate(metric = factor(metric, levels = c("rmsle","tau"),ordered = TRUE, labels=c("RMSLE", expression(paste("Kendall's ",tau)))),
         replicate = factor(replicate, levels = rev(levels(replicate)))
 ) %>% 
 ggplot(aes(x = replicate, y = value, fill = method2))+
    geom_jitter(shape = 21, size = 2.5, width = 0.05, alpha = 0.8)+
    coord_flip()+
    scale_fill_manual(values = method_colors2, limits = force)+
    ggh4x::facet_grid2(~metric, scale = "free", labeller = label_parsed)+
    ggh4x::facetted_pos_scales(y = list(metric == "RMSLE" ~ scale_y_reverse()))+
    theme_bw()+
    labs(y = "absolute values")+
    #ggforestplot::theme_forest()+
    #ggforestplot::geom_stripes(odd = "#33333333", even = "#00000000")#+
    theme(axis.title = element_blank(), axis.text = element_text(size = 11), #axis.text.y = element_text(size = 11)
          panel.spacing = unit(1.5, "lines"),
          panel.grid.major.x = element_blank(),
           panel.grid.major.y = element_line( size=5, color="grey90"))

p.estimation_eval_metrics


df_eval_metrics %>% 
  filter(metric %in% c("rmsle", "tau"),
         default == T) %>% 
  mutate(metric = factor(metric, levels = c("rmsle","tau"),ordered = TRUE, labels=c("RMSLE", expression(paste("Kendall's ",tau)))),
         replicate = factor(replicate, levels = rev(levels(replicate)))
 ) %>% 
 ggplot(aes(x = replicate, y = value, color = method2))+
    geom_jitter(size = 3, width = 0.05, alpha = 0.8)+
    coord_flip()+
    scale_color_manual(values = method_colors2, limits = force)+
    ggh4x::facet_grid2(~metric, scale = "free", labeller = label_parsed)+
    ggh4x::facetted_pos_scales(y = list(metric == "RMSLE" ~ scale_y_reverse()))+
    #theme_bw()+
    labs(y = "absolute values")+
    ggforestplot::theme_forest()+
    ggforestplot::geom_stripes(odd = "#33333333", even = "#00000000")#+
    theme(axis.title = element_blank(), axis.text = element_text(size = 11), #axis.text.y = element_text(size = 11)
          panel.spacing = unit(1.5, "lines"))
```

## FIGURE: ESTIMATION ACCURACY

```{r fig_est}
p.est_accuracy <- plot_grid(
          plot_grid(NULL,p.global_est, nrow = 1, rel_widths = c(0.05,1)),
          p.estimation_eval_metrics+theme(legend.position = "none"),
          nrow = 2, labels = c("A","B"))

p.est_accuracy

ggsave("figures/Figure5_estimation_accuracy.pdf",p.est_accuracy,  width = 5, height = 4.5)

```



### UMAP

```{r UMAP}
denisenko_colors <- setNames(
  c(RColorBrewer::brewer.pal(11, "Paired"),"darkgrey","grey"),
  c("PT","CD_IC" ,   "CD_PC", "CD_Trans" ,     "CNT" ,     "DCT",     "Endo",      "Fib","aLOH",   "dLOH",    "MC" ,    "Podo","Immune"))



cnt_mat_list <- list(uncorrected = readRDS("Snakemake_backup/benchmark/corrected/raw/rep2/raw_cormat.RDS"),
                     CellBender = readRDS("Snakemake_backup/benchmark/corrected/CellBender/rep2/fpr0.01_total25000_cormat.RDS"),
                     SoupX = readRDS("Snakemake_backup/benchmark/corrected/SoupX/rep2/res1_contAuto_cormat.RDS"),
                     DecontX = readRDS("Snakemake_backup/benchmark/corrected/DecontX/rep2/resDefault_emptyFalse_cormat.RDS"))

class_list <- list(uncorrected = readRDS("Snakemake_backup/benchmark/evaluation/raw/rep2/classification_evaluation.RDS")$raw$celltype_labels,
                   CellBender = readRDS("Snakemake_backup/benchmark/evaluation/CellBender/rep2/classification_evaluation.RDS")$fpr0.01_total25000$celltype_labels,
                   SoupX = readRDS("Snakemake_backup/benchmark/evaluation/SoupX/rep2/classification_evaluation.RDS")$res1_contAuto$celltype_labels,
                   DecontX = readRDS("Snakemake_backup/benchmark/evaluation/DecontX/rep2/classification_evaluation.RDS")$resDefault_emptyFalse$celltype_labels)


seu_rep2_CAST <- readRDS("Snakemake_backup/input/rep2/seurat_CAST.RDS")

# seu_list_rep2 <- lapply(cnt_mat_list, function(mat){
#   mat_filt <- mat[,colnames(seu_rep2_CAST)]
#   seu <- CreateSeuratObject(mat_filt, meta.data = seu_rep2_CAST@meta.data)
#   seu <- NormalizeData(seu)
#   seu <- FindVariableFeatures(seu, nfeatures = 5000)
#   seu <- ScaleData(seu)
#   seu <- RunPCA(seu)
#   seu <- RunUMAP(seu, dims = 1:30)
#   return(seu)
# })

seu_list_rep2 <- lapply(setNames(names(cnt_mat_list), names(cnt_mat_list)), function(method){
  mat_filt <- cnt_mat_list[[method]][,class_list[[method]]$cell]
  seu <- CreateSeuratObject(mat_filt, meta.data = class_list[[method]] %>% column_to_rownames("cell"))
  #seu <- filter(seu, !is.na(celltype))
  seu <- NormalizeData(seu)
  seu <- FindVariableFeatures(seu, nfeatures = 5000)
  seu <- ScaleData(seu)
  seu <- RunPCA(seu)
  seu <- RunUMAP(seu, dims = 1:30)
  seu <- seu %>% mutate(celltype = case_when(celltype %in% c("CD_IC","CD_IC_A","CD_IC_B") ~ "CD_IC",
                              #celltype %in% c("aLOH","dLOH") ~ "LOH",
                              celltype %in% c("T","NK","B","MPH") ~ "Immune",
                              T ~ celltype))
  return(seu)
})

seu_list_rep2 <- lapply(setNames(names(seu_list_rep2),names(seu_list_rep2)), function(x){
  seu_list_rep2[[x]]$label_change = ifelse(seu_list_rep2[[x]]$celltype != seu_list_rep2$uncorrected$celltype,x,"same")
  seu_list_rep2[[x]]$original_label = seu_list_rep2$uncorrected$celltype
  return(seu_list_rep2[[x]])
})


seu_list_rep2$uncorrected$label_change <- case_when(
  seu_list_rep2$uncorrected$celltype != seu_list_rep2$CellBender$celltype & seu_list_rep2$uncorrected$celltype != seu_list_rep2$DecontX$celltype ~ "multiple",
  seu_list_rep2$uncorrected$celltype != seu_list_rep2$CellBender$celltype & seu_list_rep2$uncorrected$celltype != seu_list_rep2$SoupX$celltype ~ "multiple",
  seu_list_rep2$uncorrected$celltype != seu_list_rep2$SoupX$celltype & seu_list_rep2$uncorrected$celltype != seu_list_rep2$DecontX$celltype ~ "multiple",
  seu_list_rep2$uncorrected$celltype != seu_list_rep2$CellBender$celltype & seu_list_rep2$uncorrected$celltype != seu_list_rep2$SoupX$celltype & seu_list_rep2$uncorrected$celltype != seu_list_rep2$DecontX$celltype ~ "multiple",
  seu_list_rep2$uncorrected$celltype != seu_list_rep2$CellBender$celltype ~ "CellBender",
  seu_list_rep2$uncorrected$celltype != seu_list_rep2$SoupX$celltype ~ "SoupX",
  seu_list_rep2$uncorrected$celltype != seu_list_rep2$DecontX$celltype ~ "DecontX",
  T ~ "same"
)



plot_UMAP <- function(seurat, color_by = "celltype", colors, plot_legend = F, name, highlight_label_change = T, add_caption = T){
  p <- ggplot(filter(seurat, !is.na(celltype)), aes_string(x = "UMAP_1", y = "UMAP_2", color = color_by))+
    geom_point(size = 0.1)+
    scale_color_manual(values = colors)+
    theme_bw()+
    facet_grid(~as.character(name))+
    theme(axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(),
          strip.text = element_text(size = 9))
  
  if(plot_legend == F){
    p <- p+theme(legend.position = "none")
  }
  
  if(highlight_label_change == T){
    if(sum(seurat$label_change != "same", na.rm = T) > 0){
      p <- p+geom_point(data = filter(as.tibble(seurat), label_change != "same"), mapping =  aes_string(x = "UMAP_1", y = "UMAP_2",fill = color_by, shape = "label_change"), size = 1.3, color = "black")+
        scale_fill_manual(values = colors)+
        scale_shape_manual(values = setNames(c(21,22,23,24),c("multiple", "CellBender","SoupX","DecontX")))
    }
  }
  
  if(add_caption == T){
    n_reassigned <- sum(seurat$label_change != "same", na.rm = T)
    frac_reassigned <- sum(seurat$label_change != "same", na.rm = T) / length(seurat$label_change)
    label_reassigned <- paste0("reassigned: ", n_reassigned, " cells (",round(frac_reassigned*100,1),"%)")
    if(name == "uncorrected"){label_reassigned = ""}
    p <- p + labs(caption = label_reassigned)
  }
  
  return(p)
}


p.UMAPs_ct <- plot_grid(plotlist = lapply(setNames(names(seu_list_rep2), names(seu_list_rep2)),
                            function(x){plot_UMAP(seu_list_rep2[[x]], colors = denisenko_colors,name = x)}),
          nrow = 1)

p.UMAPs_ct


## nuc2

cnt_mat_list_nuc2 <- list(uncorrected = readRDS("Snakemake_backup/benchmark/corrected/raw/nuc2/raw_cormat.RDS"),
                     CellBender = readRDS("Snakemake_backup/benchmark/corrected/CellBender/nuc2/fpr0.01_total25000_cormat.RDS"),
                     SoupX = readRDS("Snakemake_backup/benchmark/corrected/SoupX/nuc2/res1_contAuto_cormat.RDS"),
                     DecontX = readRDS("Snakemake_backup/benchmark/corrected/DecontX/nuc2/resDefault_emptyFalse_cormat.RDS"))

seu_nuc2_CAST <- readRDS("Snakemake_backup/input/nuc2/seurat_CAST.RDS")

seu_list_nuc2 <- lapply(cnt_mat_list_nuc2, function(mat){
  mat_filt <- mat[,colnames(seu_nuc2_CAST)]
  seu <- CreateSeuratObject(mat_filt, meta.data = seu_nuc2_CAST@meta.data)
  seu <- NormalizeData(seu)
  seu <- FindVariableFeatures(seu, nfeatures = 5000)
  seu <- ScaleData(seu)
  seu <- RunPCA(seu)
  seu <- RunUMAP(seu, dims = 1:30)
  return(seu)
})

plot_grid(plotlist = lapply(seu_list_nuc2, plot_UMAP, colors = denisenko_colors), nrow = 2, 
          labels = names(seu_list_nuc2))

```

Overlay UMAP with marker genes: 

```{r UMAP_marker}
plot_UMAP_marker <- function(seu, gene, name){
  expr <- seu@assays$RNA@counts[gene,]
  seu$log_expr <- log2(expr+1)
  seu$log_expr <- ifelse(seu$log_expr > 6, 6, seu$log_expr)
  
  p.UMAP <- ggplot(filter(seu, !is.na(log_expr)), aes(x =UMAP_1, y = UMAP_2, color = log_expr))+
      geom_point(size = 0.1)+
      scale_color_continuous(low = "lightgrey", high = "red",limits = c(0,6))+
      #scale_y_continuous(limits = c(-20,15))+
      #annotate("text", x = 3, y = 8, label = "PT cells")+
      theme_bw()+
      facet_grid(~as.character(name))+
      #ggtitle("Slc34a1 expression (rep 2)")+
      labs(x = "UMAP 1", y = "UMAP 2", color = "log2(count+1)")+
      theme(legend.position = "none", 
            axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank(),
            strip.text = element_text(size = 10))
  
    if(sum(seu$label_change != "same", na.rm = T) > 0){
      p.UMAP <- p.UMAP+geom_point(data = filter(as.tibble(seu), label_change != "same" & original_label == "PT"), mapping =  aes(fill = log_expr, shape = label_change), size = 1.3, color = "black")+
        scale_shape_manual(values = setNames(c(21,22,23,24),c("multiple", "CellBender","SoupX","DecontX")))+
        scale_fill_continuous(low = "lightgrey", high = "red",limits = c(0,6))
    }
  
  return(p.UMAP)
}

plot_grid(plotlist = lapply(seu_list_nuc2, plot_UMAP_marker, gene = "Slc34a1"), nrow = 2, 
          labels = names(seu_list_nuc2))


p.UMAPs_marker <- plot_grid(plotlist = lapply(setNames(names(seu_list_rep2), names(seu_list_rep2)),
                            function(x){plot_UMAP_marker(seu_list_rep2[[x]], gene = "Slc34a1",name = x)+
                                theme(strip.background = element_blank(),strip.text.x = element_blank())
                                }),
          nrow = 1)

p.UMAPs_marker



denisenko_colors2 <- setNames(c(denisenko_colors,NA), c(names(denisenko_colors),NA))

legend_celltypes <-  get_legend(plot_UMAP(seu_list_rep2$uncorrected, colors = denisenko_colors, plot_legend = T, name = "uncorrected")+
                                  guides(colour = guide_legend(override.aes = list(size=3))))
                                  
legend_celltypes_wide <- get_legend(ggplot(filter(seu_list_rep2$CellBender, !is.na(celltype)), aes(x=UMAP_1, y = UMAP_2, color = celltype))+
  geom_point()+theme_bw()+guides(colour = guide_legend(override.aes = list(size=2), nrow = 2))+theme(legend.position = "top")+
    scale_color_manual(values = denisenko_colors, limits = force))
                                  


legend_Slc_expr <- get_legend(plot_UMAP_marker(seu_list_rep2$uncorrected, gene = "Slc34a1",name = "uncorrected")+
                                theme(legend.position = "right")+labs(color = "Slc34a1 expr. \n [log2(counts+1)]"))

legend_Slc_expr_wide <- get_legend(plot_UMAP_marker(filter(seu_list_rep2$uncorrected, label_change != "same"), gene = "Slc34a1",name = "uncorrected")+
                                theme(legend.position = "bottom")+labs(color = "Slc34a1 expr. \n [log2(counts+1)]")+
                                  guides(fill = "none", shape= "none"))


legend_reassignment <- get_legend(ggplot(data = filter(seu_list_rep2$uncorrected, label_change != "same"), mapping =  aes_string(x = "UMAP_1", y = "UMAP_2",shape = "label_change"), size = 3, color = "black")+ geom_point()+
        scale_shape_manual(values = setNames(c(21,22,23,24),c("multiple", "CellBender","SoupX","DecontX")))+
        guides(shape=guide_legend(title="reassignment in"))+
        theme_bw())


p.UMAPs_ct_slc <- plot_grid(
  plot_grid(p.UMAPs_ct, legend_celltypes, 
            nrow = 1, rel_widths = c(1,0.14)), 
  plot_grid(p.UMAPs_marker, legend_Slc_expr, 
            nrow = 1, rel_widths = c(1,0.14)),
  nrow = 2, labels = c("A","B"), label_size = 16, scale = c(0.95,0.95))


p.UMAPs_ct_slc <- plot_grid(
  plot_grid(p.UMAPs_ct, p.UMAPs_marker, 
            nrow = 2, labels = c("A","B"), label_size = 16, scale = c(0.95,0.95)),
  plot_grid(legend_celltypes, legend_reassignment, legend_Slc_expr, NULL,
            nrow = 4, rel_heights = c(0.9,0.5,0.5,0.0005)),
  nrow = 1, rel_widths = c(1,0.14))
            
p.UMAPs_ct_slc


ggsave("figures/Suppl_figure_UMAPs_corrected.pdf", p.UMAPs_ct_slc, width = 13, height = 7)


# top bottom legend arrangement

p.UMAPs <- plot_grid(
  plot_grid(
    legend_celltypes_wide,
    p.UMAPs_ct, 
    p.UMAPs_marker,
    legend_Slc_expr_wide,
    nrow = 4, labels = c("","A","B",""), scale = c(1,0.95,0.95,1), rel_heights = c(0.2,1.1,0.9,0.2)),
  legend_reassignment,
  nrow = 1, rel_widths = c(1,0.15)
)

```


Overlay UMAP with estimated contamination: 

```{r UMAP_cont_fraction}
seu_list_rep2$uncorrected <- AddMetaData(seu_list_rep2$uncorrected, perCell_methods_df %>% filter(replicate == "rep2", method == "Genotype estimate") %>% column_to_rownames("cell"))
seu_list_rep2$CellBender <- AddMetaData(seu_list_rep2$CellBender, perCell_methods_df %>% filter(replicate == "rep2", method == "CellBender") %>% column_to_rownames("cell"))
seu_list_rep2$DecontX <- AddMetaData(seu_list_rep2$DecontX, perCell_methods_df %>% filter(replicate == "rep2", method == "DecontX") %>% column_to_rownames("cell"))
seu_list_rep2$SoupX <- AddMetaData(seu_list_rep2$SoupX, perCell_methods_df %>% filter(replicate == "rep2", method == "SoupX") %>% column_to_rownames("cell"))

plot_UMAP_contamination <- function(seu){
  ggplot(seu, aes(x =UMAP_1, y = UMAP_2, color = cont))+
      geom_point(size = 0.6)+
      scale_color_gradient2(low = "red", mid = "grey", high = "blue", limits = c(0,0.9), midpoint = 0.1)+
      #scale_color_continuous(low = "lightgrey", high = "blue", limits = c(0,0.7))+
      scale_y_continuous(limits = c(-20,15))+
      #annotate("text", x = 3, y = 8, label = "PT cells")+
      theme_bw()+
      #ggtitle("Slc34a1 expression (rep 2)")+
      labs(x = "UMAP 1", y = "UMAP 2", color = "contamination_fraction")+
      theme(legend.position = "bottom", 
            axis.text = element_blank(), axis.ticks = element_blank())+
    geom_point(data = filter(as.tibble(seu), label_change != "same"), mapping =  aes(fill = cont, shape = label_change), size = 3, color = "black")+
        scale_shape_manual(values = setNames(c(21,22,23,24),c("multiple", "CellBender","SoupX","DecontX")))+
        scale_fill_gradient2(low = "red", mid = "grey", high = "blue", limits = c(0,0.9), midpoint = 0.1)

}

plot_grid(plotlist = lapply(seu_list_rep2, plot_UMAP_contamination), nrow = 1, 
          labels = names(seu_list_rep2))


perCell_methods_df

```

```{r total_sum}
seu_list_uncorrected <- list()
for(rep in c("rep1","rep2","rep3", "nuc3","nuc2")){ 
  seu_list_uncorrected[[rep]] <- readRDS(paste0("Snakemake_backup/input/",rep,"/seurat.RDS"))
}

lapply(seu_list_uncorrected, function(x){
  sum(x@assays$RNA@counts)
})

```


#### Contamination per cell type

```{r cont_per_celltype}
pC_est <- perCell_methods_df %>%  
  left_join(cell_metadata) %>% 
  filter(celltype %in% c("PT", "aLOH","DCT","Endo","CD_PC", "CD_IC")) %>% 
  mutate(replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc3", "nuc2")),
         method2 = factor(method2, levels = c("Genotype estimate", "CellBender","SoupX", "DecontX_default", "DecontX_background")),
         celltype = factor(celltype, levels = c("PT", "aLOH","DCT","Endo","CD_PC", "CD_IC")))


p.est_per_celltype <- ggplot(pC_est, aes(x = method2, y= cont, fill = celltype))+
  geom_boxplot(outlier.color = NA)+
  scale_fill_manual(values = denisenko_colors, limits = force)+
  facet_grid(~replicate)+
  #scale_y_continuous(limits = c(0,0.5))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), 
        axis.title.x = element_blank())+
  labs(y = "% background RNA per cell")

ggsave("figures/Suppl_figure_estimation_accuracy_perCT.pdf",p.est_per_celltype,  width = 12, height = 3.5)

```

### Classification overlap 

```{r class_overlap}
class_overlap_summary <- class_overlap_df %>% 
  filter(!is.na(celltype) & !is.na(celltype_uncorrected) & method != "raw") %>% 
  left_join(select(df_eval_metrics, c(method,replicate, param,default))) %>% 
  filter(default == T) %>% 
  distinct() %>% 
  group_by(replicate, method, param) %>% 
  #group_by(replicate, method,setting, param) %>% 
  summarize(overlap = sum(celltype == celltype_uncorrected) / length(celltype),
            n_reassigned = sum(celltype != celltype_uncorrected),
            ARI = mclust::adjustedRandIndex(celltype, celltype_uncorrected),
            overlap_fine = sum(label == label_uncorrected) / length(label))




plot_overlap <- function(metric){
  class_overlap_summary %>% 
    #filter(setting == "default") %>% 
    ggplot(aes_string(x = "method", y=metric, color = "replicate"))+
      geom_point(size = 3)+
      scale_color_manual(values = replicate_colors)+
      theme_bw()+
      theme(legend.position = "bottom")
}

plot_grid(
  plot_overlap("overlap"),
  #plot_overlap("overlap_fine"),
  plot_overlap("ARI"),
  nrow = 1
)

class_overlap_df %>% 
  left_join(select(df_eval_metrics, c(method,replicate, param,default))) %>% 
  filter(default == T) %>% 
  distinct() %>% 
  saveRDS("Extra_analyses/classification_corrected_data.RDS")


# overlap per cell type
class_overlap_summary_ct <- class_overlap_df %>% 
  left_join(select(df_eval_metrics, c(method,replicate, param,default))) %>% 
  filter(default == T) %>% 
  distinct() %>% 
  filter(!is.na(celltype) & !is.na(celltype_uncorrected) & method != "raw") %>% 
  group_by(replicate, method,param, celltype) %>% 
  summarize(overlap = sum(celltype == celltype_uncorrected) / length(celltype),
            n_reassigned = sum(celltype != celltype_uncorrected),
            ARI = mclust::adjustedRandIndex(celltype, celltype_uncorrected),
            overlap_fine = sum(label == label_uncorrected) / length(label))

class_overlap_summary_ct %>% 
  #filter(setting == "default") %>% 
  ggplot(aes(x = method, y=overlap, color = replicate))+
  geom_point(size = 3)+
  coord_flip()+
  scale_color_manual(values = replicate_colors)+
  facet_grid(celltype~., scales = "free")+
  theme_bw()+
  theme(legend.position = "bottom")
```

#### Classification of genotype cleaned data 

```{r genotype_classification}
ct_genotype <- readRDS("Extra_analyses/corrected_classification.RDS") 

ct_genotype_df <- lapply(ct_genotype, function(x)x$celltype) %>% 
  bind_rows(.id = "replicate") %>% 
  dplyr::rename(celltype_gt = celltype) %>% 
  mutate(celltype_gt = case_when(celltype_gt %in% c("CD_IC","CD_IC_A","CD_IC_B") ~ "CD_IC",
                              #celltype %in% c("aLOH","dLOH") ~ "LOH",
                              celltype_gt %in% c("T","NK","B","MPH") ~ "Immune",
                              T ~ celltype_gt))

saveRDS(ct_genotype_df, "Extra_analyses/celltype_assignments_gt_cleaned.RDS")

cell_metadata <- readRDS("Extra_analyses/cell_metadata.RDS")
cell_metadata <- cell_metadata %>% 
  left_join(ct_genotype_df)
saveRDS(cell_metadata, "Extra_analyses/cell_metadata.RDS")


tmp <- class_overlap_df %>% 
  left_join(ct_genotype_df)

class_overlap_summary <- tmp %>% 
  filter(!is.na(celltype) & !is.na(celltype_gt)) %>% 
  left_join(select(df_eval_metrics, c(method,replicate, param,default))) %>% 
  filter(default == T) %>% 
  distinct() %>% 
  group_by(replicate, method, param) %>% 
  mutate(replicate = factor(replicate, levels = c("rep3", "rep1", "rep2", "nuc2"))) %>% 
  #group_by(replicate, method,setting, param) %>% 
  summarize(overlap = sum(celltype == celltype_gt) / length(celltype),
            n_reassigned = sum(celltype != celltype_gt),
            ARI = mclust::adjustedRandIndex(celltype, celltype_gt))

plot_overlap_method <- function(metric){
  class_overlap_summary %>% 
    #filter(setting == "default") %>% 
    ggplot(aes_string(x = "replicate", y=metric, color = "method"))+
      geom_jitter(size = 3, width = 0.1)+
      scale_color_manual(values = method_colors, limits = force)+
      theme_bw()+
      theme(legend.position = "bottom")
}

plot_grid(
  plot_overlap_method("overlap"),
  #plot_overlap("overlap_fine"),
  plot_overlap_method("ARI"),
  nrow = 1
)

class_overlap_summary_ct <- tmp %>% 
  left_join(select(df_eval_metrics, c(method,replicate, param,default))) %>% 
  filter(default == T) %>% 
  distinct() %>% 
  filter(!is.na(celltype) & !is.na(celltype_gt)) %>% 
  group_by(replicate, method,param, celltype) %>% 
  summarize(overlap = sum(celltype == celltype_gt) / length(celltype),
            n_reassigned = sum(celltype != celltype_gt),
            ARI = mclust::adjustedRandIndex(celltype, celltype_gt))

class_overlap_summary_ct %>% 
  #filter(setting == "default") %>% 
  ggplot(aes(x = replicate, y=overlap, color = method))+
  geom_jitter(size = 2, width = 0.1)+
  coord_flip()+
  scale_color_manual(values = method_colors, limits = force)+
  facet_grid(celltype~., scales = "free")+
  theme_bw()+
  theme(legend.position = "bottom")

```


### Assemble figure - downstream analysis

```{r figure}
p.downstream_benchmark_old <- plot_grid(
  p.UMAPs,
  plot_grid(
    p.seurat_lfc_topGenes+theme(legend.position = "right", legend.title = element_blank()),
    p.genes_match+theme(legend.position = "none"),
    nrow = 1, labels = c("C","D"), scale = c(0.95,0.95), align = "hv", rel_widths = c(1,0.7)#, axis = "blrt"
  ),
  p.cluster_evaluation,
  nrow = 3, rel_heights = c(1,0.7,0.7), scale = c(0.95,0.95,0.95))



p.downstream_benchmark <- plot_grid(
  p.UMAPs,
  plot_grid(
    p.seurat_lfc_topGenes,
    p.expr_frac_topGenes+theme(legend.position = "right", legend.title = element_blank()),
    nrow = 1, labels = c("C","D"), scale = c(0.95,0.95), align = "hv", rel_widths = c(0.65,1)#, axis = "blrt"
  ),
  plot_grid(p.cluster_evaluation_range+theme(legend.position = "none"), labels = "E"),
  nrow = 3, rel_heights = c(1,0.6,0.6), scale = c(0.95,0.95,0.95))

p.downstream_benchmark_new <- plot_grid(
  p.UMAPs,
  plot_grid(
    p.expr_frac_topGenes,
    p.seurat_lfc_topGenes+theme(legend.position = "right", legend.title = element_blank()),
    nrow = 1, labels = c("C","D"), scale = c(0.95,0.95), align = "hv", rel_widths = c(0.65,1)#, axis = "blrt"
  ),
  plot_grid(p.cluster_evaluation_range+theme(legend.position = "none"), labels = "E"),
  nrow = 3, rel_heights = c(1,0.6,0.6), scale = c(0.95,0.95,0.95), align = "hv", axis = "l")

#ggsave("figures/Figure6_downstream_benchmark.pdf", p.downstream_benchmark, width = 9, height = 9)
ggsave("figures/Figure6_downstream_benchmark_new.pdf", p.downstream_benchmark_new, width = 9, height = 9)

```


### Suppl: Parameter settings

```{r param_settings}
df_zscore <- df_eval_metrics %>% 
  # Reverse metrics for which low value = better
  mutate(delta = ifelse(metric %in% c("rmsle", "expression_fraction"), -delta, delta)) %>% 
  # Remove estimation accuracy for parameter settings in which the contamination fraction has to be set  
  filter(!(evaluation_category == "estimation_accuracy" & grepl("cont0",param))) %>% 
  #filter(method!="raw") %>%
  group_by(metric, replicate) %>% 
  mutate(mean=mean(delta, na.rm = T),
         sd=sd(delta, na.rm = T),
         dist_to_mean = delta-mean,
         zscore = dist_to_mean/sd) 

df_zscore_mergeReplicates <- df_zscore %>%
  group_by(method, param, evaluation_category, metric) %>% 
  summarise(mean_zscore = mean(zscore)) %>% 
  ungroup() %>% 
  group_by(metric) %>% 
  mutate(
    metric_available_for_raw = ifelse("raw" %in% method, T, F), 
    raw_value = ifelse(metric_available_for_raw == T, mean_zscore[method == "raw"], NA),
    improvement = ifelse(mean_zscore > raw_value, T, F),
    best_performance = ifelse(mean_zscore == max(mean_zscore), T, F))


# heatmap of different parameter settings

  
inp_param_setting <- df_zscore_mergeReplicates %>% 
  filter(metric %in% c("tau", "rmsle","prediction_score", "purity", "avg_silhouette","expression_fraction", "lfc","kNN_overlap"),
         method != "raw", 
         !grepl("cont0.05",param)
         ) %>%
  mutate(param = sub("_total25000","",param),
         #param = sub("_emptyFalse", "", param),
         evaluation_category = case_when(evaluation_category == "estimation_accuracy" ~ "estimation \n accuracy",
                                         evaluation_category == "cluster_evaluation" ~ "cell type \n identification",
                                         evaluation_category == "marker_evaluation" ~ "marker gene \n detection"),
         evaluation_category = factor(evaluation_category, levels = c("estimation \n accuracy","marker gene \n detection","cell type \n identification")),
         param = ifelse(method == "SoupX", paste0(word(param,2,2,"_"),"_", word(param,1,1,"_")), param),
         param = factor(param,levels = c("fpr0.01","fpr0.05","fpr0.1",
                                         "resDefault_emptyFalse","res0.5_emptyFalse","res1_emptyFalse","res2_emptyFalse",
                                         "resDefault_emptyTrue","res0.5_emptyTrue","res1_emptyTrue","res2_emptyTrue",
                                         "contAuto_res1","contAuto_res0.5","contAuto_res2",
                                         "cont0.1_res0.5","cont0.1_res1","cont0.1_res2",
                                         "cont0.2_res0.5","cont0.2_res1","cont0.2_res2")),
         metric_pretty = case_when(metric == "expression_fraction" ~ "Unspecific \n detection",
                                   metric == "prediction_score" ~ "Prediction \n score",
                                   metric == "purity" ~ "Purity",
                                   metric == "avg_silhouette" ~ "Average silhouette",
                                   metric == "tau" ~ "Kendall's tau",
                                   metric == "rmsle" ~ "RMSLE",
                                   metric == "lfc" ~ "Log2 fold change",
                                   metric == "kNN_overlap" ~ "k-NN overlap",
                                   T ~ metric))

# highlight default in axis text
#default_highlight_color <- ifelse(levels(inp_param_setting$param) %in% c("fpr0.01", "resDefault_emptyTrue", "resDefault_emptyFalse","contAuto_res1"), "red","black") 

  
p.parameter_settings <-  ggplot(inp_param_setting, aes(x = param, y = metric_pretty, fill = mean_zscore))+
    geom_tile(color = "darkgrey")+
    #geom_boxplot(aes(fill = method), alpha = 0.7)+
    scale_fill_gradient2(low = "darkorange", high = "darkgreen")+
    scale_y_discrete(position = "right")+
    facet_grid(evaluation_category~method,scales = "free", space = "free", switch = "y")+
    geom_hline(yintercept = 0)+
    theme_bw()+
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color = c("red",rep("black",10))), 
          axis.title = element_blank(),strip.text.y = element_text(angle = 180), 
          legend.position = "top", legend.text = element_text(size = 8),
          strip.background = element_rect(fill = "white"), strip.text.x = element_text(face = "bold"))

p.parameter_settings

ggsave("figures/Suppl_figure_parameter_settings.pdf", width = 8.5, height = 5.5)
```


## Supplement: corrected UMAPs for all replicates


```{r prepare_seurat}
prepare_seurat <- function(rep){
  cnt_mat_list <- list(uncorrected = readRDS(paste0("Snakemake_backup/benchmark/corrected/raw/",rep,"/raw_cormat.RDS")),
                       CellBender = readRDS(paste0("Snakemake_backup/benchmark/corrected/CellBender/",rep,"/fpr0.01_total25000_cormat.RDS")),
                       SoupX = readRDS(paste0("Snakemake_backup/benchmark/corrected/SoupX/",rep,"/res1_contAuto_cormat.RDS")),
                       DecontX = readRDS(paste0("Snakemake_backup/benchmark/corrected/DecontX/",rep,"/resDefault_emptyFalse_cormat.RDS")))
  
  class_list <- list(uncorrected = readRDS(paste0("Snakemake_backup/benchmark/evaluation/raw/",rep,"/classification_evaluation.RDS"))$raw$celltype_labels,
                     CellBender = readRDS(paste0("Snakemake_backup/benchmark/evaluation/CellBender/",rep,"/classification_evaluation.RDS"))$fpr0.01_total25000$celltype_labels,
                     SoupX = readRDS(paste0("Snakemake_backup/benchmark/evaluation/SoupX/",rep,"/classification_evaluation.RDS"))$res1_contAuto$celltype_labels,
                     DecontX = readRDS(paste0("Snakemake_backup/benchmark/evaluation/DecontX/",rep,"/classification_evaluation.RDS"))$resDefault_emptyFalse$celltype_labels)
  
  
  seu_list <- lapply(setNames(names(cnt_mat_list), names(cnt_mat_list)), function(method){
    mat_filt <- cnt_mat_list[[method]][,class_list[[method]]$cell]
    seu <- CreateSeuratObject(mat_filt, meta.data = class_list[[method]] %>% column_to_rownames("cell"))
    #seu <- filter(seu, !is.na(celltype))
    seu <- NormalizeData(seu)
    seu <- FindVariableFeatures(seu, nfeatures = 5000)
    seu <- ScaleData(seu)
    seu <- RunPCA(seu)
    seu <- RunUMAP(seu, dims = 1:30)
    seu <- seu %>% mutate(celltype = case_when(celltype %in% c("CD_IC","CD_IC_A","CD_IC_B") ~ "CD_IC",
                                #celltype %in% c("aLOH","dLOH") ~ "LOH",
                                celltype %in% c("T","NK","B","MPH") ~ "Immune",
                                T ~ celltype))
    return(seu)
  })
  
  seu_list <- lapply(setNames(names(seu_list),names(seu_list)), function(x){
    seu_list[[x]]$label_change = ifelse(seu_list[[x]]$celltype != seu_list$uncorrected$celltype,x,"same")
    seu_list[[x]]$original_label = seu_list$uncorrected$celltype
    return(seu_list[[x]])
  })
  
  
  seu_list$uncorrected$label_change <- case_when(
    seu_list$uncorrected$celltype != seu_list$CellBender$celltype & seu_list$uncorrected$celltype != seu_list$DecontX$celltype ~ "multiple",
    seu_list$uncorrected$celltype != seu_list$CellBender$celltype & seu_list$uncorrected$celltype != seu_list$SoupX$celltype ~ "multiple",
    seu_list$uncorrected$celltype != seu_list$SoupX$celltype & seu_list$uncorrected$celltype != seu_list$DecontX$celltype ~ "multiple",
    seu_list$uncorrected$celltype != seu_list$CellBender$celltype & seu_list$uncorrected$celltype != seu_list$SoupX$celltype & seu_list$uncorrected$celltype != seu_list$DecontX$celltype ~ "multiple",
    seu_list$uncorrected$celltype != seu_list$CellBender$celltype ~ "CellBender",
    seu_list$uncorrected$celltype != seu_list$SoupX$celltype ~ "SoupX",
    seu_list$uncorrected$celltype != seu_list$DecontX$celltype ~ "DecontX",
    T ~ "same"
  )
  
  return(seu_list)
}

seu_list_rep1 <- prepare_seurat("rep1")
seu_list_rep2 <- prepare_seurat("rep2")
seu_list_rep3 <- prepare_seurat("rep3")
seu_list_nuc2 <- prepare_seurat("nuc2")
seu_list_nuc3 <- prepare_seurat("nuc3")

```

### UMAPs with cell types

```{r UMAPs_ct}
plot_UMAP_ct <- function(seu_list){
   plot_grid(plotlist = lapply(setNames(names(seu_list), names(seu_list)),
                            function(x){plot_UMAP(seu_list[[x]], colors = denisenko_colors,name = x)}),
          nrow = 1)
}


legend_celltypes_wide2 <- get_legend(ggplot(filter(seu_list_rep2$CellBender, !is.na(celltype)), aes(x=UMAP_1, y = UMAP_2, color = celltype))+
  geom_point()+theme_bw()+guides(colour = guide_legend(override.aes = list(size=2), nrow = 2))+
    scale_color_manual(values = denisenko_colors, limits = force))
legend_reassignment2 <- get_legend(ggplot(data = filter(seu_list_rep2$uncorrected, label_change != "same"), mapping =  aes_string(x = "UMAP_1", y = "UMAP_2",shape = "label_change"), size = 3, color = "black")+ geom_point()+
        scale_shape_manual(values = setNames(c(21,22,23,24),c("multiple", "CellBender","SoupX","DecontX")))+
        guides(shape=guide_legend(title="reassignment in", nrow = 2))+ 
        theme_bw())


p.UMAP_ct_rep <- plot_grid(
  NULL,
  plot_UMAP_ct(seu_list_rep1),
  plot_UMAP_ct(seu_list_rep2),
  plot_UMAP_ct(seu_list_rep3),
  plot_UMAP_ct(seu_list_nuc2),
  plot_UMAP_ct(seu_list_nuc3), 
  plot_grid(legend_celltypes_wide2, legend_reassignment2),
  ncol = 1, labels = c("","rep1", "rep2", "rep3", "nuc2", "nuc3"), label_y = 1.11, rel_heights = c(0.1,1,1,1,1,1,0.35)
)

ggsave("figures/Suppl_figure_UMAPs_corrected_CT.pdf",  p.UMAP_ct_rep, width = 9, height = 12)


```

## UMAPs with Slc34a1 expression

```{r UMAPs_slc}
plot_UMAP_corrected_slc <- function(seu_list){
   plot_grid(plotlist = lapply(setNames(names(seu_list), names(seu_list)),
                            function(x){plot_UMAP_marker(seu_list[[x]], gene = "Slc34a1",name = x)
                                }),
          nrow = 1)
}

p.UMAP_slc_rep <- plot_grid(
  NULL,
  plot_UMAP_corrected_slc(seu_list_rep1),
  plot_UMAP_corrected_slc(seu_list_rep2),
  plot_UMAP_corrected_slc(seu_list_rep3),
  plot_UMAP_corrected_slc(seu_list_nuc2),
  plot_UMAP_corrected_slc(seu_list_nuc3), 
  plot_grid(legend_Slc_expr_wide, legend_reassignment2),
  ncol = 1, labels = c("","rep1", "rep2", "rep3", "nuc2", "nuc3"), label_y = 1.07, rel_heights = c(0.1,1,1,1,1,1,0.35), scale = 0.95
)

ggsave("figures/Suppl_figure_UMAPs_corrected_Slc34a1.pdf",  p.UMAP_slc_rep, width = 9, height = 11)


```


